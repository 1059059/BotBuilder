<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>$title | Bot Builder SDK C# Reference Library | Bot Framework</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
    <!--
<link href="/js/doxygen/navtree.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/js/doxygen/resize.js"></script>
<script type="text/javascript" src="/js/doxygen/navtreedata.js"></script>
<script type="text/javascript" src="/js/doxygen/navtree.js"></script>
        -->
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="botframework.css" rel="stylesheet" type="text/css"/>
<link rel="stylesheet" href="/css/documentation.css">
    <script type="text/javascript">
        $(document).ready(function () {
            var sidenav = $('#side-nav');
            sidenav.before('<div id="content-container" class="outline"></div>');
            var doccontent = $('#doc-content');
			var contentcontainer = $('#content-container');
            contentcontainer.append(sidenav);
            contentcontainer.append(doccontent);
            doccontent.prepend($('#referenceSearch'));
			var top = $('#top');
			top.before('<div class="fullWidth"></div>');
			var fullwidth = $('div.fullWidth');
			fullwidth.before('<div id="app-body"></div>');
			fullwidth.append(top);
			fullwidth.append(contentcontainer);
			fullwidth.append($('.footer'));
			var appbody = $('#app-body');
			appbody.append(fullwidth);
			$('#MSearchField').removeAttr('value').attr('placeholder', 'Search the Bot Builder SDK C# reference');
        });
    </script>
</head>
<body>
<div id="referenceSearch"></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
	<div>
		<header>
			<div class="outline">
				<div class="header">
					<a class="logo" href="//www.microsoft.com">
						<svg class="svgicon svgicon-microsoft-color-logo">
							<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="/images/symbol-defs.svg#svgicon-microsoft-color-logo" />
						</svg>
					</a>
					<div class="loading-animation"></div>
					<span class="environment"></span>
					<div>
					</div>
				</div>
			</div>
		</header>
		<div class="brand-primary">
			<div class="jumbo">
				<div class="jumbo-header"><a href="https://www.botframework.com/">Bot Framework</a></div>
					<ul class="header-nav"><li><a href="https://dev.botframework.com/#/bots">My bots</a>
						</li><li>
						<a href="https://dev.botframework.com/#/bots/new">Register a bot</a></li><li class="active">
						<a href="/">Documentation</a></li><li>
						<a href="https://bots.botframework.com/" class="active">Bot Directory</a></li></ul>
				</div>
			</div>
		</div>
	</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('Dialogs.html','');});
</script>
<div id="doc-content">
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#dialogs">Dialogs</a><ul><li class="level2"><a href="#Overview">Overview</a></li>
<li class="level2"><a href="#simpleEcho">Simple Echo Bot</a></li>
<li class="level2"><a href="#echoBot">Echo Bot</a></li>
<li class="level2"><a href="#alarmBot">Alarm Bot</a></li>
<li class="level2"><a href="#IDialog">IDialog</a></li>
<li class="level2"><a href="#IDialogContext">IDialogContext</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="dialogs"></a>
Dialogs</h1>
<h2><a class="anchor" id="Overview"></a>
Overview</h2>
<p>Dialogs model a conversational process, where the exchange of messages between bot and user is the primary channel for interaction with the outside world. Each dialog is an abstraction that encapsulates its own state in a C# class that implements <a class="el" href="da/d12/interface_microsoft_1_1_bot_1_1_builder_1_1_i_dialog.html">IDialog</a>. Dialogs can be composed with other dialogs to maximize reuse, and a dialog context maintains a stack of dialogs active in the conversation. A conversation composed of dialogs is portable across machines to make it possible to scale a bot implementation. This conversation state (the stack of active dialogs and each dialog's state) is stored in the messages exchanged with the Bot Connector, making the bot implementation stateless between requests. (Much like a web application that does not store session state in the web server's memory.)</p>
<p>The best way to understand this is to work through some examples. The first example changes the code in the <a class="el" href="d5/d61/namespace_microsoft_1_1_bot.html">Bot</a> Framework template to use dialogs from the <a class="el" href="d5/d61/namespace_microsoft_1_1_bot.html">Bot</a> <a class="el" href="d3/ddb/namespace_microsoft_1_1_bot_1_1_builder.html">Builder</a>. The second example, <a class="el" href="Dialogs.html#echoBot">Echo Bot</a> builds on that to add some simple state. The final example <a class="el" href="Dialogs.html#alarmBot">Alarm Bot</a> uses the <a href="http://luis.a">LUIS</a> natural language framework and some of the built-in system prompts.</p>
<h2><a class="anchor" id="simpleEcho"></a>
Simple Echo Bot</h2>
<p>This example starts with the bot you get by starting your <a class="el" href="d5/d61/namespace_microsoft_1_1_bot.html">Bot</a> the <a class="el" href="d5/d61/namespace_microsoft_1_1_bot.html">Bot</a> Framework template which includes code to echo back what the user says. In order to change the echo example to use the <a class="el" href="d5/d61/namespace_microsoft_1_1_bot.html">Bot</a> <a class="el" href="d3/ddb/namespace_microsoft_1_1_bot_1_1_builder.html">Builder</a>, we need to add a C# class to represent our conversation and its state. You can do this by adding this class to your MessagesController.cs file:  <div class="fragment"><div class="line">    [Serializable]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class </span>EchoDialog : IDialog</div><div class="line">    {</div><div class="line">        <span class="keyword">public</span> async Task <a class="code" href="d3/ddb/namespace_microsoft_1_1_bot_1_1_builder.html#ab4ddbcbc7c828827ea4fef3436207056">StartAsync</a>(IDialogContext context)</div><div class="line">        {</div><div class="line">            context.Wait(MessageReceivedAsync);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">public</span> async Task MessageReceivedAsync(IDialogContext context, IAwaitable&lt;Message&gt; argument)</div><div class="line">        {</div><div class="line">            var message = await argument;</div><div class="line">            await context.PostAsync(<span class="stringliteral">&quot;You said: &quot;</span> + message.Text);</div><div class="line">            context.Wait(MessageReceivedAsync);</div><div class="line">        }</div><div class="line">    }</div></div><!-- fragment --></p>
<p>Next we need to wire this class into your Post method like this:  <div class="fragment"><div class="line">        <span class="keyword">public</span> async Task&lt;Message&gt; Post([FromBody]Message message)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (message.Type == <span class="stringliteral">&quot;Message&quot;</span>)</div><div class="line">            {</div><div class="line">                <span class="comment">// return our reply to the user</span></div><div class="line">                <span class="keywordflow">return</span> await Conversation.SendAsync(message, () =&gt; <span class="keyword">new</span> EchoDialog());</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <span class="keywordflow">return</span> HandleSystemMessage(message);</div><div class="line">            }</div></div><!-- fragment --></p>
<p>The method is marked async because the <a class="el" href="d5/d61/namespace_microsoft_1_1_bot.html">Bot</a> Framework makes use of the C# facilities for handling asynchronous communication. It returns a Task&lt;Message&gt; which is the reply to the passed in Message. If there is an exception, the Task will contain the exception information. Within the Post method we call <a class="el" href="df/dcb/class_microsoft_1_1_bot_1_1_builder_1_1_conversation.html#ac64ed0df5286546b97bb8919d41224f6">Conversation.SendAsync</a> which is the root method for the <a class="el" href="d5/d61/namespace_microsoft_1_1_bot.html">Bot</a> <a class="el" href="d3/ddb/namespace_microsoft_1_1_bot_1_1_builder.html">Builder</a> SDK. It follows the dependency inversion principle (<a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle">https://en.wikipedia.org/wiki/Dependency_inversion_principle</a>) and does the following steps:</p><ul>
<li>Instantiate the required components.</li>
<li>Deserialize the dialog state (the dialog stack and each dialog's state) from the Bot Connector message.</li>
<li>Resume the conversation processes where the Bot decided to suspend and wait for a message.</li>
<li>Queues messages to be sent to the user.</li>
<li>Serializes the updated dialog state in messages sent back to the user.</li>
</ul>
<p>When your conversation first starts, there is no dialog state in the message so the delegate passed to <a class="el" href="df/dcb/class_microsoft_1_1_bot_1_1_builder_1_1_conversation.html#ac64ed0df5286546b97bb8919d41224f6">Conversation.SendAsync</a> will be used to construct an EchoDialog and it's StartAsync method will be called. In this case, StartAsync calls <a class="el" href="d5/dd1/interface_microsoft_1_1_bot_1_1_builder_1_1_i_dialog_stack.html#a43c4645f5df008e59113d593fb9a8e8d" title="Suspend the current dialog until the user has sent a message to the bot. ">IDialogContext.Wait</a> with the continuation delegate (our MessageReceivedAsync method) to call when there is a new message. In the initial case there is an immediate message available (the one that launched the dialog) and it is immediately passed To MessageReceivedAsync.</p>
<p>Within MessageReceivedAsync we wait for the message to come in and then post our response and wait for the next message. In this simple case the next message would again be processed by MessageReceivedAsync. Every time we call <a class="el" href="d5/dd1/interface_microsoft_1_1_bot_1_1_builder_1_1_i_dialog_stack.html#a43c4645f5df008e59113d593fb9a8e8d" title="Suspend the current dialog until the user has sent a message to the bot. ">IDialogContext.Wait</a> our bot is suspended and can be restarted on any machine that receives the message.</p>
<p>If you run and test this bot, it will behave exactly like the original one from the <a class="el" href="d5/d61/namespace_microsoft_1_1_bot.html">Bot</a> Framework template. It is a little more complicated, but it allows you to compose together multiple dialogs into complex conversations without having to explicitly manage state.</p>
<h2><a class="anchor" id="echoBot"></a>
Echo Bot</h2>
<p>Now that we have an example of the <a class="el" href="d5/d61/namespace_microsoft_1_1_bot.html">Bot</a> <a class="el" href="d3/ddb/namespace_microsoft_1_1_bot_1_1_builder.html">Builder</a> framework we are going to build on it to add some dialog state and some commands to control that state. We are going to number the responses and allow the command "reset" to reset the count. All we need to do is to replace our EchoDialog with the one below.  <div class="fragment"><div class="line">    [Serializable]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class </span>EchoDialog : IDialog</div><div class="line">    {</div><div class="line">        <span class="keyword">private</span> <span class="keywordtype">int</span> count = 1;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> async Task <a class="code" href="d3/ddb/namespace_microsoft_1_1_bot_1_1_builder.html#ab4ddbcbc7c828827ea4fef3436207056">StartAsync</a>(IDialogContext context)</div><div class="line">        {</div><div class="line">            context.Wait(MessageReceivedAsync);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">public</span> async Task MessageReceivedAsync(IDialogContext context, IAwaitable&lt;Message&gt; argument)</div><div class="line">        {</div><div class="line">            var message = await argument;</div><div class="line">            <span class="keywordflow">if</span> (message.Text == <span class="stringliteral">&quot;reset&quot;</span>)</div><div class="line">            {</div><div class="line">                Prompts.Confirm(</div><div class="line">                    context,</div><div class="line">                    AfterResetAsync,</div><div class="line">                    <span class="stringliteral">&quot;Are you sure you want to reset the count?&quot;</span>,</div><div class="line">                    <span class="stringliteral">&quot;Didn&#39;t get that!&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                await context.PostAsync(<span class="keywordtype">string</span>.Format(<span class="stringliteral">&quot;{0}: You said {1}&quot;</span>, this.count++, message.Text));</div><div class="line">                context.Wait(MessageReceivedAsync);</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">public</span> async Task AfterResetAsync(IDialogContext context, IAwaitable&lt;bool&gt; argument)</div><div class="line">        {</div><div class="line">            var confirm = await argument;</div><div class="line">            <span class="keywordflow">if</span> (confirm)</div><div class="line">            {</div><div class="line">                this.count = 1;</div><div class="line">                await context.PostAsync(<span class="stringliteral">&quot;Reset count.&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                await context.PostAsync(<span class="stringliteral">&quot;Did not reset count.&quot;</span>);</div><div class="line">            }</div><div class="line">            context.Wait(MessageReceivedAsync);</div><div class="line">        }</div><div class="line">    }</div></div><!-- fragment --></p>
<p>The first change you will notice is the addition of <code>private int count = 1;</code>. This is the state we are persisting with this dialog on each message.</p>
<p>In MessageReceivedAsync we have added check to see if the input was "reset" and if that is true we use the built-in <a class="el" href="de/db4/class_microsoft_1_1_bot_1_1_builder_1_1_prompts.html#a47ecb0468b23e607b589c1a7b17fbd52">Prompts.Confirm</a> dialog to spawn a sub-dialog that asks the user if they are sure about resetting the count. The sub-dialog has its own private state and does not need to worry about interfering with the parent dialog. When the sub dialog is done, it's result is then passed onto the AfterResetAync method. In AfterResetAsync we check on the response and perform the action including sending a message back to the user. The final step is to do <a class="el" href="d5/dd1/interface_microsoft_1_1_bot_1_1_builder_1_1_i_dialog_stack.html#a43c4645f5df008e59113d593fb9a8e8d" title="Suspend the current dialog until the user has sent a message to the bot. ">IDialogContext.Wait</a> with a continuation back to MessageReceivedAsync on the next message.</p>
<h2><a class="anchor" id="alarmBot"></a>
Alarm Bot</h2>
<h2><a class="anchor" id="IDialog"></a>
IDialog</h2>
<p>The IDialog&lt;T&gt; interface provides a single <a class="el" href="da/d12/interface_microsoft_1_1_bot_1_1_builder_1_1_i_dialog.html#aa5d12e93e41084e58ffbe74b22fe4cbe" title="The start of the code that represents the conversational dialog. ">IDialog&lt;T&gt;.StartAsync</a> method that serves as the entry point to the dialog. The StartAsync method takes an argument and the dialog context. Your IDialog&lt;T&gt; implementation must be serializable if you expect to suspend that dialog's execution to collect more Messages from the user.</p>
<h2><a class="anchor" id="IDialogContext"></a>
IDialogContext</h2>
<p>The <a class="el" href="d3/d92/interface_microsoft_1_1_bot_1_1_builder_1_1_i_dialog_context.html" title="The context for the execution of a dialog&#39;s conversational process. ">IDialogContext</a> interface is composed of three interfaces: <a class="el" href="d6/dc0/interface_microsoft_1_1_bot_1_1_builder_1_1_i_bot_data.html" title="Private bot data. ">IBotData</a>, <a class="el" href="d5/dd1/interface_microsoft_1_1_bot_1_1_builder_1_1_i_dialog_stack.html" title="The stack of dialogs in the conversational process. ">IDialogStack</a>, and <a class="el" href="dc/dcc/interface_microsoft_1_1_bot_1_1_builder_1_1_i_bot_to_user.html" title="Methods to send a message from the bot to the user. ">IBotToUser</a>.</p>
<p><a class="el" href="d6/dc0/interface_microsoft_1_1_bot_1_1_builder_1_1_i_bot_data.html" title="Private bot data. ">IBotData</a> represents access to the per user, conversation, and user in conversation state maintained by the Bot Connector.</p>
<p><a class="el" href="d5/dd1/interface_microsoft_1_1_bot_1_1_builder_1_1_i_dialog_stack.html" title="The stack of dialogs in the conversational process. ">IDialogStack</a> provides methods to</p><ul>
<li>call children dialogs (and push the new child on the dialog stack),</li>
<li>mark the current dialog as done to return a result to the calling dialog (and pop the current dialog from the dialog stack), and</li>
<li>wait for a message from the user and suspend the conversation.</li>
</ul>
<p><a class="el" href="dc/dcc/interface_microsoft_1_1_bot_1_1_builder_1_1_i_bot_to_user.html" title="Methods to send a message from the bot to the user. ">IBotToUser</a> provides methods to post messages to be sent to the user, according to some policy. Some of these messages may be sent inline with the response to the web api method call, and some of these messages may be sent directly using the Bot Connector client. Sending and receiving messages through the dialog context ensures the <a class="el" href="d6/dc0/interface_microsoft_1_1_bot_1_1_builder_1_1_i_bot_data.html" title="Private bot data. ">IBotData</a> state is passed through the Bot Connector.</p>
<p>TODO:</p><ul>
<li>Need to describe limitations on context in messages</li>
<li>Need to describe the stores off of <a class="el" href="da/d12/interface_microsoft_1_1_bot_1_1_builder_1_1_i_dialog.html">IDialog</a></li>
<li>Link up to reference docs </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<!-- id is needed for treeview function! -->
<div class="outline footer">
	<ul>
        <li><a href="//aka.ms/bf-contactus">Contact us</a></li>
        <li><a href="//aka.ms/bf-privacy">Privacy & cookies</a></li>
        <li><a href="//aka.ms/bf-terms">Terms of use</a></li>
        <li><a href="//aka.ms/bf-conduct">Code of conduct</a></li>
        <li>&copy; 2016 Microsoft</li>
	</ul>
</div>
</body>
</html>
