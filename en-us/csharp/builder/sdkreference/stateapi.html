<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Bot State Service | Bot Builder SDK C# Reference Library | Bot Framework</title>
    <link href="tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="botframework.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="/css/documentation.css?1" />
    <script type="text/javascript" src="/css/documents.js"></script>
    <!-- START OF SmartSource Data Collector TAG v10.4.23 -->
    <!-- Copyright (c) 2016 Webtrends Inc.  All rights reserved. -->
    <script type="text/javascript" src="/js/webtrends.load.js"></script>
    <!--
      appInsights
    -->
    <script type="text/javascript">
    var appInsights=window.appInsights||function(config){
      function r(config){t[config]=function(){var i=arguments;t.queue.push(function(){t[config].apply(t,i)})}}var t={config:config},u=document,e=window,o="script",s=u.createElement(o),i,f;for(s.src=config.url||"//az416426.vo.msecnd.net/scripts/a/ai.0.js",u.getElementsByTagName(o)[0].parentNode.appendChild(s),t.cookie=u.cookie,t.queue=[],i=["Event","Exception","Metric","PageView","Trace"];i.length;)r("track"+i.pop());return r("setAuthenticatedUserContext"),r("clearAuthenticatedUserContext"),config.disableExceptionTracking||(i="onerror",r("_"+i),f=e[i],e[i]=function(config,r,u,e,o){var s=f&&f(config,r,u,e,o);return s!==!0&&t["_"+i](config,r,u,e,o),s}),t
      }({
          instrumentationKey:"ecf7f29d-de8c-4169-a492-bdce0a32c300"
      });
      window.appInsights=appInsights;
      appInsights.trackPageView();
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            var sidenav = $('#side-nav');
            sidenav.before('<div id="content-container" class="outline"></div>');
            var doccontent = $('#doc-content');
			var contentcontainer = $('#content-container');
            contentcontainer.append(sidenav);
            contentcontainer.append(doccontent);
            doccontent.prepend($('#referenceSearch'));
			var top = $('#top');
			top.before('<div class="fullWidth"></div>');
			var fullwidth = $('div.fullWidth');
			fullwidth.before('<div id="app-body"></div>');
			fullwidth.append(top);
			fullwidth.append(contentcontainer);
			fullwidth.append($('.footer'));
			var appbody = $('#app-body');
			appbody.append(fullwidth);
			var navtreecontents = $('#nav-tree-contents');
			navtreecontents.prepend('<ul><li><div class="label"><a href="/">&lt; Documentation Home</a></div></li></ul>');
			//sidenav.prepend('<div id="wrapper"><form id="docs-search-form" action="/en-us/search/"><input id="q" name="q" type="text" placeholder=""><input type="hidden" id="v" name="v" value="v3"><input type="hidden" id="mkt" name="mkt" value="en-us"><button id="bt_search" name="bt_search" class="icon-search" type="submit"></button></form></div>');
            //sidenav.prepend('<div id="wrapper"><form id="docs-search-form" action="/en-us/search/"><select id="lang-select" name="lang" ><option value="">All</option><option value="node">Node.js</option><option value="csharp">.NET</option></select><input id="q" name="q" type="text" placeholder=""><input type="hidden" id="v" name="v" value="v3"><input type="hidden" id="mkt" name="mkt" value="en-us"><button id="bt_search" name="bt_search" class="icon-search" type="submit"></button></form></div>');
            setProgrammingLanguage();
			$('#MSearchField').removeAttr('value').attr('placeholder', 'Search the Bot Builder SDK C# reference');
        });
    </script>
</head>
<body>
    <div id="referenceSearch"></div>
    <div id="top">
        <!-- do not remove this div, it is closed by doxygen! -->
        <div>
            <header>
                <div class="outline">
                    <div class="header">
                        <a class="logo" href="//www.microsoft.com">
                            <svg class="svgicon svgicon-microsoft-color-logo">
                                <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="/images/symbol-defs.svg#svgicon-microsoft-color-logo"></use>
                            </svg>
                        </a>
                        <div class="loading-animation"></div>
                        <span class="environment"></span>
                        <div>
                        </div>
                    </div>
                </div>
            </header>
            <div class="brand-primary">
                <div class="jumbo">
                    <div class="jumbo-header"><a href="https://www.botframework.com/">Bot Framework</a></div>
                    <ul class="header-nav">
                        <li><a href="https://dev.botframework.com/#/bots">My bots</a></li>
                        <li><a href="https://dev.botframework.com/#/bots/new">Register a bot</a></li>
                        <li class="active"><a href="/">Documentation</a></li>
                        <li><a href="https://bots.botframework.com/">Bot Directory</a></li>
                        <li><a href="https://blog.botframework.com/">Blog</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- end header part -->
</body>
</html><!-- Generated by Doxygen 1.8.11 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('stateapi.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Bot State Service </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A key to good bot design is to</p><ul>
<li>make the web service stateless so that it can be scaled</li>
<li>make it track context of a conversation.</li>
</ul>
<p>Since all bots have these requirements the Bot Framework has a service for storing bot state. This lets your bot track things like <em>what was the last question I asked them?</em>.</p>
<h1><a class="anchor" id="contextualproperties"></a>
Useful properties for tracking state</h1>
<p>Every Activity has several properties which are useful for tracking state.</p>
<table class="doxtable">
<tr>
<th><b>Property</b> </th><th><b>Description</b> </th><th><b>Use cases</b>  </th></tr>
<tr>
<td><b>From</b> </td><td>A Users's address on a channel (ex: email address) </td><td>Remembering context for a user on a channel </td></tr>
<tr>
<td><b>Conversation</b> </td><td>A unique id for a conversation </td><td>Remembering context all users in a conversation </td></tr>
<tr>
<td><b>From + Conversation</b> </td><td>A user in a conversation </td><td>Remembering context for a user in a conversation </td></tr>
</table>
<p>You can use these keys to store information in your own database as appropriate to your needs.</p>
<h1><a class="anchor" id="botstateapi"></a>
State Methods</h1>
<p>The Bot State service exposes the following methods</p>
<table class="doxtable">
<tr>
<th><b>Method</b> </th><th><b>Scoped to</b> </th><th><b>Use cases</b>  </th></tr>
<tr>
<td><b>GetUserData()</b> </td><td>User </td><td>Remembering context object with a user </td></tr>
<tr>
<td><b>GetConversationData()</b> </td><td>Conversation </td><td>Remembering context object with a conversation </td></tr>
<tr>
<td><b>GetPrivateConversationData()</b> </td><td>User &amp; Conversation </td><td>Remembering context object with a person in a conversation </td></tr>
<tr>
<td><b>SetUserData()</b> </td><td>User </td><td>Remembering context object with a user </td></tr>
<tr>
<td><b>SetConversationData()</b> </td><td>Conversation </td><td>Remembering context object with a conversation </td></tr>
<tr>
<td><b>SetPrivateConversationData()</b> </td><td>User &amp; Conversation </td><td>Remembering context object with a person in a conversation </td></tr>
<tr>
<td><b>DeleteStateForUser()</b> </td><td>User </td><td>When the user requests data be deleted or removes the bot contact </td></tr>
</table>
<p>When your bot sends a reply you simply set your object in one of the BotData records properties and it will be persisted and played back to you on future messages when the context is the same. Your bot may store data for a user, a conversation, or a single user within a conversation (called "private" data). Each payload may be up to 32 kilobytes in size. The data may be removed by the bot or upon a user's request, e.g. if the user requests the channel to inform the bot (and therefore, the Bot Framework) to delete the user's data.</p>
<blockquote class="doxtable">
<p>NOTE: If the record doesn't exist, it will return a new BotData() record with a null .Data field and an ETag = "*", so that is suitable for changing and passing back to be saved </p>
</blockquote>
<h1><a class="anchor" id="stateclient"></a>
Creating State Client</h1>
<p>The default state client is stored in central service. For some channel ids you may want to use a state API hosted in the channel itself (for example with the "emulator" channel) so that state can be stored in a compliant store which the channel supplies.</p>
<p>We have provided a helper method on the Activity object which makes it easy to get an appropriate StateClient for a given message. </p><div class="fragment"><div class="line">StateClient stateClient = activity.GetStateClient();</div></div><!-- fragment --><h1><a class="anchor" id="getsetproperties"></a>
Get/SetProperty Methods</h1>
<p>The C# library has helper methods called SetProperty() and GetProperty() which make it easy to get and set any type of data from a BotData record, including complex objects.</p>
<p>Setting typed data </p><div class="fragment"><div class="line">BotData userData = await stateClient.BotState.GetUserDataAsync(activity.ChannelId, activity.From.Id);</div><div class="line">userData.SetProperty&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;SentGreeting&quot;</span>, <span class="keyword">true</span>);</div><div class="line">await stateClient.BotState.SetUserDataAsync(activity.ChannelId, activity.From.Id, userData);</div></div><!-- fragment --><p>Getting typed data </p><div class="fragment"><div class="line">BotData userData = await stateClient.BotState.GetUserDataAsync(activity.ChannelId, activity.From.Id);</div><div class="line"><span class="keywordflow">if</span> (userData.GetProperty&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;SentGreeting&quot;</span>))</div><div class="line">        ... <span class="keywordflow">do</span> something ...;</div></div><!-- fragment --><p>Example of setting a complex type</p>
<div class="fragment"><div class="line">BotState botState = <span class="keyword">new</span> BotState(stateClient);</div><div class="line">BotData botData = <span class="keyword">new</span> BotData(eTag: <span class="stringliteral">&quot;*&quot;</span>);</div><div class="line">botData.SetProperty&lt;BotState&gt;(<span class="stringliteral">&quot;UserData&quot;</span>, myUserData);</div><div class="line">BotData response = await stateClient.BotState.SetUserDataAsync(activity.ChannelId, activity.From.Id, botData);</div></div><!-- fragment --><p>Getting a complex type </p><div class="fragment"><div class="line">MyUserData addedUserData = <span class="keyword">new</span> MyUserData();</div><div class="line">BotData botData = await botState.GetUserDataAsync(activity.ChannelId, activity.From.Id);</div><div class="line">myUserData = botData.GetProperty&lt;MyUserData&gt;(<span class="stringliteral">&quot;UserData&quot;</span>);</div></div><!-- fragment --><h1><a class="anchor" id="concurrency"></a>
Concurrency</h1>
<p>These botData objects will fail to be stored if another instance of your bot has changed the object already.</p>
<p>Example of using the REST API client library: </p><div class="fragment"><div class="line"><span class="keywordflow">try</span></div><div class="line">{</div><div class="line">    <span class="comment">// get the user data object</span></div><div class="line">    BotData userData = await botState.GetUserDataAsync(activity.ChannelId, activity.From.Id);</div><div class="line"></div><div class="line">    <span class="comment">// modify it...</span></div><div class="line">    userData.Data = ...modify...;</div><div class="line"></div><div class="line">    <span class="comment">// save it</span></div><div class="line">    await botState.SetUserDataAsync(activity.ChannelId, activity.From.Id, userData);</div><div class="line">}</div><div class="line"><span class="keywordflow">catch</span> (HttpOperationException err)</div><div class="line">{</div><div class="line">    <span class="comment">// handle precondition failed error if someone else has modified your object</span></div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<!-- id is needed for treeview function! -->
<div class="outline footer">
    <ul>
        <li><a href="//aka.ms/bf-contactus">Contact us</a></li>
        <li><a href="//aka.ms/bf-privacy">Privacy & cookies</a></li>
        <li><a href="//aka.ms/bf-terms">Terms of use</a></li>
        <li><a href="//aka.ms/bf-conduct">Code of conduct</a></li>
        <li>&copy; 2016 Microsoft</li>
    </ul>
</div>
<script src="//bot-framework.azureedge.net/libs/svgxuse.js"></script>
<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100954936); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100954936ns.gif" /></p></noscript>
</body>
</html>
