<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Calling | Bot Builder SDK C# Reference Library | Bot Framework</title>
    <link href="tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="botframework.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="/css/documentation.css?1" />
    <script type="text/javascript" src="/css/documents.js"></script>
    <!-- START OF SmartSource Data Collector TAG v10.4.23 -->
    <!-- Copyright (c) 2016 Webtrends Inc.  All rights reserved. -->
    <script type="text/javascript" src="/js/webtrends.load.js"></script>
    <!--
      appInsights
    -->
    <script type="text/javascript">
    var appInsights=window.appInsights||function(config){
      function r(config){t[config]=function(){var i=arguments;t.queue.push(function(){t[config].apply(t,i)})}}var t={config:config},u=document,e=window,o="script",s=u.createElement(o),i,f;for(s.src=config.url||"//az416426.vo.msecnd.net/scripts/a/ai.0.js",u.getElementsByTagName(o)[0].parentNode.appendChild(s),t.cookie=u.cookie,t.queue=[],i=["Event","Exception","Metric","PageView","Trace"];i.length;)r("track"+i.pop());return r("setAuthenticatedUserContext"),r("clearAuthenticatedUserContext"),config.disableExceptionTracking||(i="onerror",r("_"+i),f=e[i],e[i]=function(config,r,u,e,o){var s=f&&f(config,r,u,e,o);return s!==!0&&t["_"+i](config,r,u,e,o),s}),t
      }({
          instrumentationKey:"ecf7f29d-de8c-4169-a492-bdce0a32c300"
      });
      window.appInsights=appInsights;
      appInsights.trackPageView();
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            var sidenav = $('#side-nav');
            sidenav.before('<div id="content-container" class="outline"></div>');
            var doccontent = $('#doc-content');
			var contentcontainer = $('#content-container');
            contentcontainer.append(sidenav);
            contentcontainer.append(doccontent);
            doccontent.prepend($('#referenceSearch'));
			var top = $('#top');
			top.before('<div class="fullWidth"></div>');
			var fullwidth = $('div.fullWidth');
			fullwidth.before('<div id="app-body"></div>');
			fullwidth.append(top);
			fullwidth.append(contentcontainer);
			fullwidth.append($('.footer'));
			var appbody = $('#app-body');
			appbody.append(fullwidth);
			var navtreecontents = $('#nav-tree-contents');
			navtreecontents.prepend('<ul><li><div class="label"><a href="/">&lt; Documentation Home</a></div></li></ul>');
			//sidenav.prepend('<div id="wrapper"><form id="docs-search-form" action="/en-us/search/"><input id="q" name="q" type="text" placeholder=""><input type="hidden" id="v" name="v" value="v3"><input type="hidden" id="mkt" name="mkt" value="en-us"><button id="bt_search" name="bt_search" class="icon-search" type="submit"></button></form></div>');
            //sidenav.prepend('<div id="wrapper"><form id="docs-search-form" action="/en-us/search/"><select id="lang-select" name="lang" ><option value="">All</option><option value="node">Node.js</option><option value="csharp">.NET</option></select><input id="q" name="q" type="text" placeholder=""><input type="hidden" id="v" name="v" value="v3"><input type="hidden" id="mkt" name="mkt" value="en-us"><button id="bt_search" name="bt_search" class="icon-search" type="submit"></button></form></div>');
            setProgrammingLanguage();
			$('#MSearchField').removeAttr('value').attr('placeholder', 'Search the Bot Builder SDK C# reference');
        });
    </script>
</head>
<body>
    <div id="referenceSearch"></div>
    <div id="top">
        <!-- do not remove this div, it is closed by doxygen! -->
        <div>
            <header>
                <div class="outline">
                    <div class="header">
                        <a class="logo" href="//www.microsoft.com">
                            <svg class="svgicon svgicon-microsoft-color-logo">
                                <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="/images/symbol-defs.svg#svgicon-microsoft-color-logo"></use>
                            </svg>
                        </a>
                        <div class="loading-animation"></div>
                        <span class="environment"></span>
                        <div>
                        </div>
                    </div>
                </div>
            </header>
            <div class="brand-primary">
                <div class="jumbo">
                    <div class="jumbo-header"><a href="https://www.botframework.com/">Bot Framework</a></div>
                    <ul class="header-nav">
                        <li><a href="https://dev.botframework.com/#/bots">My bots</a></li>
                        <li><a href="https://dev.botframework.com/#/bots/new">Register a bot</a></li>
                        <li class="active"><a href="/">Documentation</a></li>
                        <li><a href="https://bots.botframework.com/">Bot Directory</a></li>
                        <li><a href="https://blog.botframework.com/">Blog</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- end header part -->
</body>
</html><!-- Generated by Doxygen 1.8.11 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('calling.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Calling </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="docs-text-note"><b>Note:</b> This is a Skype only feature.</div> <h1><a class="anchor" id="tutorialivr"></a>
Building a simple Skype Calling Bot</h1>
<p>Let's say you want to build an Interactive Voice Response (<a href="https://en.wikipedia.org/wiki/Interactive_voice_response">IVR</a>) bot to automate common tasks for incoming customer calls. You can read more about <a href="/en-us/skype/calling/">Skype Calling API</a> to understand the mechanism for receiving and handling Skype voice calls by bots. Below, you can read how to build a simple Skype <a class="el" href="d0/d20/namespace_microsoft_1_1_bot_1_1_builder_1_1_calling.html" title="Root namespace for the Microsoft Bot Builder Calling SDK. ">Calling</a> bot.</p>
<h2><a class="anchor" id="ivrrequirements"></a>
Requirements</h2>
<p>If you don't already have them, download:</p>
<ul>
<li>Visual Studio 2015 (latest update) - you can download the community version here for free: <a href="https://www.visualstudio.com/">www.visualstudio.com</a> Make sure you have <a href="https://www.microsoft.com/en-us/download/details.aspx?id=48137">.Net Framework 4.6</a> or later and <a href="https://azure.microsoft.com/en-gb/documentation/articles/dotnet-sdk/">Azure SDK for .NET</a>.</li>
<li><p class="startli">A free <a class="el" href="dc/d75/namespace_microsoft_1_1_bot_1_1_builder_1_1_azure.html" title="Namespace for Azure extensions to the Microsoft Bot Builder SDK. ">Azure</a> account or <a href="https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/?WT.mc_id=A261C142F">an active Visual Studio subscription</a> You get $200 in free credits with your account. If you've used up your credits, you can still use the free services and features (such as the Web Apps in the <a class="el" href="dc/d75/namespace_microsoft_1_1_bot_1_1_builder_1_1_azure.html" title="Namespace for Azure extensions to the Microsoft Bot Builder SDK. ">Azure</a> App Service).</p>
<div class="docs-text-note"><b>Note:</b> If you're using a different version of Visual Studio, your screens will look a little different.</div></li>
</ul>
<h2><a class="anchor" id="ivrquickstarts"></a>
Quick Start</h2>
<p>If you don't feel like working through the tutorial, you can use the following step-by-step guide to have a working bot:</p><ol type="1">
<li>Install prerequisite software<ul>
<li>Visual Studio 2015 (latest update) - you can download the community version here for free: <a href="https://www.visualstudio.com/">www.visualstudio.com</a></li>
<li>Important: Please update all VS extensions to their latest versions Tools-&gt;Extensions and Updates-&gt;Updates</li>
</ul>
</li>
<li>Download and install the Calling Bot Application template<ul>
<li>Download the file from the direct download link <b><a href="https://aka.ms/bf-builder-calling">here</a></b>:</li>
<li>Save the zip file to your Visual Studio 2015 templates directory which is traditionally in "%USERPROFILE%\Documents\Visual Studio 2015\Templates\ProjectTemplates\Visual C#\"</li>
</ul>
</li>
<li>Open Visual Studio</li>
<li>Create a new C# project using the new Calling Bot Application template. <div class="image">
<img src="/en-us/images/ivr/calling-getstarted-create-project.png"  alt="Create a new C\# project using the new %Calling %Bot Application template."/>
</div>
</li>
<li>The template is a fully functional Calling Bot that has a simple menu letting the user to record her/his voice. In order to run however,<ul>
<li>The Bot has to be registered with <a href="https://dev.botframework.com">Bot Framework developer portal</a>. After registration is complete you should go to Skype channel configuration page and enable calling for your Bot and register your calling endpoint with Skype. <div class="image">
<img src="/en-us/images/ivr/skypeconfig.png"  alt="Create a new C\# project using the new %Calling %Bot Application template."/>
</div>
</li>
<li>The AppId and AppPassword from the Bot Framework registration page have to be recorded in the project's web.config</li>
<li>The <code>Microsoft.Bot.Builder.Calling.CallbackUrl</code> should match the route set for CallingEvent in the template. Template will setup the callback route to <code><a href="https://">https://</a>&lt;your domain&gt;/api/calling/callback</code>.<ul>
<li>Example: if your service is deployed to ivrtest.azurewebsites.net, then the URL will be <em><a href="https://ivrtest.azurewebsites.net/api/calling/callback">https://ivrtest.azurewebsites.net/api/calling/callback</a></em></li>
</ul>
</li>
<li>Modify the Routes for both methods in Controllers\CallingController.cs<ul>
<li><b>ProcessIncomingCallAsync</b>: Route depends on the calling URL that was used during registration. For example if <a href="https://ivrtest.azurewebsites.net/api/calling/call">https://ivrtest.azurewebsites.net/api/calling/call</a> was registered wit the Bot Framework developer portal, route should be <b>api/calling/call</b></li>
<li><b>ProcessCallingEventAsync</b>: Route needs to match the URL specified in service configuration, i.e. web.config. It will be <b>api/calling/callback</b> in our template.</li>
</ul>
</li>
<li>The project needs to be published to the web</li>
</ul>
</li>
</ol>
<h1><a class="anchor" id="ivrstepbystep"></a>
Step-by-step tutorial</h1>
<p>Let's build a Skype Calling Bot. </p>
<p>Create an ASP.NET Web Application.  Don't know how?  Follow the steps in <a href="http://www.asp.net/visual-studio/overview/2015/creating-web-projects-in-visual-studio">Creating ASP.NET Web Projects in Visual Studio</a>. In "Select a template" window choose the "Empty" option. In the same window please choose "Web API" option from "Add folders and core references" menu.</p>
<div class="docs-text-note"><b>Note:</b> The Library Package Manager has been renamed. As of Visual Studio 2015 (and updated versions of 2013) it's called the NuGet Package Manager</div><h2><a class="anchor" id="ivrbotsettings"></a>
Bot Settings</h2>
<p>It's time to configure your bot. The settings are in Web.config file in *appSettings* section. See Configuration Options (below) for descriptions of what each setting does.</p>
<div class="fragment"><div class="line">configuration&gt;</div><div class="line"> &lt;appSettings&gt;</div><div class="line">   &lt;add key=<span class="stringliteral">&quot;Microsoft.Bot.Builder.Calling.CallbackUrl&quot;</span> value=<span class="stringliteral">&quot;https://put your service URL here/api/calling/callback&quot;</span> /&gt;</div><div class="line"> &lt;/appSettings&gt;</div></div><!-- fragment --><h2><a class="anchor" id="ivraddskypebotsreference"></a>
Add the Microsoft.Bot.Builder.Calling NuGet package</h2>
<p>The Bot builder calling SDK is provided as a NuGet package. You can install the NuGet package from here: <a href="https://www.nuget.org/packages/Microsoft.Bot.Builder.Calling/">https://www.nuget.org/packages/Microsoft.Bot.Builder.Calling/</a></p>
<h2><a class="anchor" id="ivrimplementation"></a>
Implementation</h2>
<h3><a class="anchor" id="ivrimplementationcreatecontrollerclass"></a>
Create Controller class</h3>
<p>The controller needs to inherit from ApiController class and be decorated with <code>BotAuthentication</code> attribute. The BotAuthentication decoration on the class is used to validate your Bot credentials over HTTPS. In the constructor of the controller you should register the factory method that creates your bot with the <a class="el" href="d6/d56/class_microsoft_1_1_bot_1_1_builder_1_1_calling_1_1_calling_conversation.html" title="The top level composition root for calling SDK. ">CallingConversation</a> module.</p>
<p>Let's assume that during registration the bot's URL for calling was set to <a href="https://ivrtest.cloudapp.net/api/calling/call">https://ivrtest.azurewebsites.net/api/calling/call</a> and **Microsoft.Bot.Builder.Calling.CallbackUrl**  option was set to <a href="https://ivrtest.cloudapp.net/api/calling/callback">https://ivrtest.azurewebsites.net/api/calling/callback</a>.</p>
<p>Route attributes for methods:</p>
<ul>
<li><b>ProcessIncomingCallAsync</b> - Route depends on the calling URL that was used during registration, it's <em>api/calling/call</em> in our example</li>
<li><b>ProcessCallingEventAsync</b> - Route needs to match the URL specified in Service configuration. It needs to be <em>api/calling/callback</em> in our example</li>
</ul>
<p>The code of controller should look like:</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> <a class="code" href="d7/d4e/namespace_microsoft.html">Microsoft</a>.<a class="code" href="d5/d61/namespace_microsoft_1_1_bot.html">Bot</a>.<a class="code" href="d3/ddb/namespace_microsoft_1_1_bot_1_1_builder.html">Builder</a>.<a class="code" href="d0/d20/namespace_microsoft_1_1_bot_1_1_builder_1_1_calling.html">Calling</a>;</div><div class="line"><span class="keyword">using</span> <a class="code" href="d7/d4e/namespace_microsoft.html">Microsoft</a>.<a class="code" href="d5/d61/namespace_microsoft_1_1_bot.html">Bot</a>.<a class="code" href="db/dbb/namespace_microsoft_1_1_bot_1_1_connector.html">Connector</a>;</div><div class="line"><span class="keyword">using</span> <a class="code" href="d8/dd0/namespace_system.html">System</a>.Net.Http;</div><div class="line"><span class="keyword">using</span> <a class="code" href="d8/dd0/namespace_system.html">System</a>.Threading.Tasks;</div><div class="line"><span class="keyword">using</span> <a class="code" href="d8/dd0/namespace_system.html">System</a>.Web.Http;</div><div class="line"></div><div class="line"><span class="keyword">namespace </span><a class="code" href="d7/d4e/namespace_microsoft.html">Microsoft</a>.Bot.Sample.SimpleIVRBot</div><div class="line">{</div><div class="line">     [BotAuthentication]</div><div class="line">     [RoutePrefix(<span class="stringliteral">&quot;api/calling&quot;</span>)]</div><div class="line">     <span class="keyword">public</span> <span class="keyword">class </span>CallingController : ApiController</div><div class="line">     {</div><div class="line">         <span class="keyword">public</span> CallingController()</div><div class="line">             : base()</div><div class="line">         {</div><div class="line">             CallingConversation.RegisterCallingBot(c =&gt; <span class="keyword">new</span> SimpleIVRBot(c));</div><div class="line">         }</div><div class="line"></div><div class="line">         [Route(<span class="stringliteral">&quot;callback&quot;</span>)]</div><div class="line">         <span class="keyword">public</span> async Task&lt;HttpResponseMessage&gt; ProcessCallingEventAsync()</div><div class="line">         {</div><div class="line">             <span class="keywordflow">return</span> await CallingConversation.SendAsync(Request, <a class="code" href="d0/d20/namespace_microsoft_1_1_bot_1_1_builder_1_1_calling.html#ab9a6823b67c3f63a8d12909bdb8d1c96">CallRequestType</a>.CallingEvent);</div><div class="line">         }</div><div class="line"></div><div class="line">         [Route(<span class="stringliteral">&quot;call&quot;</span>)]</div><div class="line">         <span class="keyword">public</span> async Task&lt;HttpResponseMessage&gt; ProcessIncomingCallAsync()</div><div class="line">         {</div><div class="line">             <span class="keywordflow">return</span> await CallingConversation.SendAsync(Request, <a class="code" href="d0/d20/namespace_microsoft_1_1_bot_1_1_builder_1_1_calling.html#ab9a6823b67c3f63a8d12909bdb8d1c96">CallRequestType</a>.IncomingCall);</div><div class="line">         }</div><div class="line">     }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="ivrimplementationdefinetextmessages"></a>
Define text messages for menus</h3>
<p>We'll start with defining text messages that will be read and used for the menus.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class </span>IvrOptions</div><div class="line">{</div><div class="line">    <span class="keyword">internal</span> <span class="keyword">const</span> <span class="keywordtype">string</span> WelcomeMessage = <span class="stringliteral">&quot;Hello, you have successfully contacted XY internet service provider.&quot;</span>;</div><div class="line">    <span class="keyword">internal</span> <span class="keyword">const</span> <span class="keywordtype">string</span> MainMenuPrompt = <span class="stringliteral">&quot;If you are a new client press 1, for technical support press 2, if you need information about payments press 3, to hear more about the company press 4. To repeat the options press 5.&quot;</span>;</div><div class="line">    <span class="keyword">internal</span> <span class="keyword">const</span> <span class="keywordtype">string</span> NewClientPrompt = <span class="stringliteral">&quot;To check our latest offer press 1, to order a new service press 2. Press the hash key to return to the main menu&quot;</span>;</div><div class="line">    <span class="keyword">internal</span> <span class="keyword">const</span> <span class="keywordtype">string</span> SupportPrompt = <span class="stringliteral">&quot;To check our current outages press 1, to contact the technical support consultant press 2. Press the hash key to return to the main menu&quot;</span>;</div><div class="line">    <span class="keyword">internal</span> <span class="keyword">const</span> <span class="keywordtype">string</span> PaymentPrompt = <span class="stringliteral">&quot;To get the payment details press 1, press 2 if your payment is not visible in the system. Press the hash key to return to the main menu&quot;</span>;</div><div class="line">    <span class="keyword">internal</span> <span class="keyword">const</span> <span class="keywordtype">string</span> MoreInfoPrompt = <span class="stringliteral">&quot;XY is the leading Internet Service Provider in Prague. Our company was established in 1995 and currently has 2000 employees.&quot;</span>;</div><div class="line">    <span class="keyword">internal</span> <span class="keyword">const</span> <span class="keywordtype">string</span> NoConsultants = <span class="stringliteral">&quot;Unfortunately there are no consultants available at this moment. Please leave your name, and a brief message after the signal. You can press the hash key when finished. We will call you as soon as possible.&quot;</span>;</div><div class="line">    <span class="keyword">internal</span> <span class="keyword">const</span> <span class="keywordtype">string</span> Ending = <span class="stringliteral">&quot;Thank you for leaving the message, goodbye&quot;</span>;</div><div class="line">    <span class="keyword">internal</span> <span class="keyword">const</span> <span class="keywordtype">string</span> Offer = <span class="stringliteral">&quot;You can sign up for 100 megabit connection just for 10 euros per month till the end of month&quot;</span>;</div><div class="line">    <span class="keyword">internal</span> <span class="keyword">const</span> <span class="keywordtype">string</span> CurrentOutages = <span class="stringliteral">&quot;There is currently 1 outage in Prague 5, we are working on fixing the issue&quot;</span>;</div><div class="line">    <span class="keyword">internal</span> <span class="keyword">const</span> <span class="keywordtype">string</span> PaymentDetailsMessage = <span class="stringliteral">&quot;You should do the wire transfer till the 5th day of month to account number 3983815&quot;</span>;</div><div class="line">} </div></div><!-- fragment --><h3><a class="anchor" id="ivrimplementationmainbotclass"></a>
Implementation of main Bot class</h3>
<p>The main Bot class needs to accept IBotService as one of the arguments of its constructor and implement <a class="el" href="d4/da0/interface_microsoft_1_1_bot_1_1_builder_1_1_calling_1_1_i_calling_bot.html">ICallingBot</a> interface. In our example we also wire the events there.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span> ICallingBotService CallingBotService { <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; }</div><div class="line"></div><div class="line"><span class="keyword">public</span> SimpleIVRBot(ICallingBotService callingBotService)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (callingBotService == null)</div><div class="line">        <span class="keywordflow">throw</span> <span class="keyword">new</span> ArgumentNullException(nameof(callingBotService));</div><div class="line"></div><div class="line">    CallingBotService = callingBotService;</div><div class="line"></div><div class="line">     CallingBotService.OnIncomingCallReceived += OnIncomingCallReceived;</div><div class="line">     CallingBotService.OnPlayPromptCompleted += OnPlayPromptCompleted;</div><div class="line">     CallingBotService.OnRecordCompleted += OnRecordCompleted;</div><div class="line">     CallingBotService.OnRecognizeCompleted += OnRecognizeCompleted;</div><div class="line">     CallingBotService.OnHangupCompleted += OnHangupCompleted;</div><div class="line">}</div></div><!-- fragment --><p>Before going further let's define the constants that we'll use for mapping of user's DTMF choices to our actions. The values of constants define the choices user needs to make to reach the particular option. First four items define the choices for the main menu. The following options define the choices for the second level menus.</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> NewClient = <span class="stringliteral">&quot;1&quot;</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> Support = <span class="stringliteral">&quot;2&quot;</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> Payments = <span class="stringliteral">&quot;3&quot;</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> MoreInfo = <span class="stringliteral">&quot;4&quot;</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> NewClientOffer = <span class="stringliteral">&quot;1&quot;</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> NewClientOrder = <span class="stringliteral">&quot;2&quot;</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> SupportOutages = <span class="stringliteral">&quot;1&quot;</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> SupportConsultant = <span class="stringliteral">&quot;2&quot;</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> PaymentDetails = <span class="stringliteral">&quot;1&quot;</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> PaymentNotVisible = <span class="stringliteral">&quot;2&quot;</span>;</div></div><!-- fragment --><p>During the call our bot needs to remember the choices that the user has made. In the presented scenario the important choice is the item chosen from the main menu. For example, if the user chooses the Payments Support menu (he presses the '3' button) and then presses key '1' we know that he wants to reach <em>PaymentDetails</em> section. We'll use a helper class to keep the state:</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> <span class="keyword">class </span><a class="code" href="d9/dd2/namespace_microsoft_1_1_bot_1_1_builder_1_1_calling_1_1_object_model_1_1_misc.html#a008ba614646ad606f9c82b3165a17c64">CallState</a></div><div class="line">{</div><div class="line">    <span class="keyword">public</span> <span class="keywordtype">string</span> InitiallyChosenMenuOption { <span class="keyword">get</span>; <span class="keyword">set</span>; }</div><div class="line">}</div></div><!-- fragment --><p>We'll use the dictionary to keep the state information. We will use the Call Id as the key.</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> readonly Dictionary&lt;string, CallState&gt; _callStateMap = <span class="keyword">new</span> Dictionary&lt;string, CallState&gt;();</div></div><!-- fragment --><h3><a class="anchor" id="implementationhelpermethods"></a>
Let's also define the helper methods that we're going to use in the code.</h3>
<p>The first method creates a simple Action that reads the provided text.</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> PlayPrompt GetPromptForText(<span class="keywordtype">string</span> text)</div><div class="line">{</div><div class="line">    var prompt = <span class="keyword">new</span> Prompt { <a class="code" href="de/d58/namespace_microsoft_1_1_bot_1_1_builder_1_1_form_flow_1_1_advanced.html#a95eb4c1ce6f0a9eb18da155b77311c91a689202409e48743b914713f96d93947c">Value</a> = text, Voice = <a class="code" href="d9/dd2/namespace_microsoft_1_1_bot_1_1_builder_1_1_calling_1_1_object_model_1_1_misc.html#adda5562a43410fa476e2ca6f9a3a155f">VoiceGender</a>.Male };</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">new</span> PlayPrompt { OperationId = Guid.NewGuid().ToString(), Prompts = <span class="keyword">new</span> List&lt;Prompt&gt; { prompt } };</div><div class="line">}</div></div><!-- fragment --><p>Next method automates the creation of Recognize action. When this action is sent to <a class="el" href="d0/d20/namespace_microsoft_1_1_bot_1_1_builder_1_1_calling.html" title="Root namespace for the Microsoft Bot Builder Calling SDK. ">Calling</a> Platform the <em>textToBeRead</em> is read and the user can use the numpad to make a choice. The available options are defined by <em>numberOfOptions</em> parameter.</p>
<p>For example <em>CreateIvrOptions("test", 3, true)</em> will allow the user to choose one from *{'1', '2', '3', '#'}* options*.*</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Recognize CreateIvrOptions(<span class="keywordtype">string</span> textToBeRead, <span class="keywordtype">int</span> numberOfOptions, <span class="keywordtype">bool</span> includeBack)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (numberOfOptions &gt; 9)</div><div class="line">        <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception(<span class="stringliteral">&quot;too many options specified&quot;</span>);</div><div class="line"></div><div class="line">    var <span class="keywordtype">id</span> = Guid.NewGuid().ToString();</div><div class="line">    var choices = <span class="keyword">new</span> List&lt;RecognitionOption&gt;();</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt;= numberOfOptions; i++)</div><div class="line">    {</div><div class="line">        choices.Add(<span class="keyword">new</span> RecognitionOption { <a class="code" href="d9/dd2/namespace_microsoft_1_1_bot_1_1_builder_1_1_calling_1_1_object_model_1_1_misc.html#a2e174f6415d0ac8405d7036bb08d8aa8a49ee3087348e8d44e1feda1917443987">Name</a> = Convert.ToString(i), DtmfVariation = (char)(<span class="charliteral">&#39;0&#39;</span> + i) });</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (includeBack)</div><div class="line">        choices.Add(<span class="keyword">new</span> RecognitionOption { <a class="code" href="d9/dd2/namespace_microsoft_1_1_bot_1_1_builder_1_1_calling_1_1_object_model_1_1_misc.html#a2e174f6415d0ac8405d7036bb08d8aa8a49ee3087348e8d44e1feda1917443987">Name</a> = <span class="stringliteral">&quot;#&quot;</span>, DtmfVariation = <span class="charliteral">&#39;#&#39;</span> });</div><div class="line"></div><div class="line">    var recognize = <span class="keyword">new</span> Recognize</div><div class="line">        {</div><div class="line">            OperationId = id,</div><div class="line">            PlayPrompt = GetPromptForText(textToBeRead),</div><div class="line">            BargeInAllowed = <span class="keyword">true</span>,</div><div class="line">            Choices = choices</div><div class="line">        };</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> recognize;</div><div class="line">}</div></div><!-- fragment --><p>Below method sets up the recording for the user.</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">void</span> SetupRecording(Workflow workflow)</div><div class="line">{</div><div class="line">    var <span class="keywordtype">id</span> = Guid.NewGuid().ToString();</div><div class="line">    var prompt = GetPromptForText(IvrOptions.NoConsultants);</div><div class="line"></div><div class="line">    var record = <span class="keyword">new</span> Record</div><div class="line">        {</div><div class="line">            OperationId = id,</div><div class="line">            PlayPrompt = prompt,</div><div class="line">            MaxDurationInSeconds = 10,</div><div class="line">            InitialSilenceTimeoutInSeconds = 5,</div><div class="line">            MaxSilenceTimeoutInSeconds = 2,</div><div class="line">            PlayBeep = <span class="keyword">true</span>,</div><div class="line">            StopTones = <span class="keyword">new</span> List&lt;char&gt; { <span class="charliteral">&#39;#&#39;</span> }</div><div class="line">        };</div><div class="line"></div><div class="line">    workflow.Actions = <span class="keyword">new</span> List&lt;ActionBase&gt; { record };</div><div class="line">}</div></div><!-- fragment --><p>Next methods are responsible for creation of menus for different states.</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> <span class="keywordtype">void</span> SetupInitialMenu(Workflow workflow)</div><div class="line">{</div><div class="line">    workflow.Actions = <span class="keyword">new</span> List&lt;ActionBase&gt; { CreateIvrOptions(IvrOptions.MainMenuPrompt, 5, <span class="keyword">false</span>) };</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">private</span> Recognize CreateNewClientMenu()</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> CreateIvrOptions(IvrOptions.NewClientPrompt, 2, <span class="keyword">true</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">private</span> Recognize CreateSupportMenu()</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> CreateIvrOptions(IvrOptions.SupportPrompt, 2, <span class="keyword">true</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">private</span> Recognize CreatePaymentsMenu()</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> CreateIvrOptions(IvrOptions.PaymentPrompt, 2, <span class="keyword">true</span>);</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="ivrimplementationeventhandling"></a>
Event handling</h3>
<p>When the incoming call is received it is Answered and the user is presented with welcome message. New state entry is created for him.</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> Task OnIncomingCallReceived(IncomingCallEvent incomingCallEvent)</div><div class="line">{</div><div class="line">    var <span class="keywordtype">id</span> = Guid.NewGuid().ToString();</div><div class="line">    _callStateMap[incomingCallEvent.IncomingCall.Id] = <span class="keyword">new</span> <a class="code" href="d9/dd2/namespace_microsoft_1_1_bot_1_1_builder_1_1_calling_1_1_object_model_1_1_misc.html#a008ba614646ad606f9c82b3165a17c64">CallState</a>();</div><div class="line"></div><div class="line">    incomingCallEvent.ResultingWorkflow.Actions = <span class="keyword">new</span> List&lt;ActionBase&gt;</div><div class="line">        {</div><div class="line">            <span class="keyword">new</span> Answer { OperationId = <span class="keywordtype">id</span> },</div><div class="line">            GetPromptForText(IvrOptions.WelcomeMessage)</div><div class="line">        };</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> Task.FromResult(<span class="keyword">true</span>);</div><div class="line">}</div></div><!-- fragment --><p>Handler for the result of PlayPrompt action. The initial menu is presented to the user.</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> Task OnPlayPromptCompleted(PlayPromptOutcomeEvent playPromptOutcomeEvent)</div><div class="line">{</div><div class="line">    var callStateForClient = _callStateMap[playPromptOutcomeEvent.ConversationResult.Id];</div><div class="line"></div><div class="line">    callStateForClient.InitiallyChosenMenuOption = null;</div><div class="line">    SetupInitialMenu(playPromptOutcomeEvent.ResultingWorkflow);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> Task.FromResult(<span class="keyword">true</span>);</div><div class="line">}</div></div><!-- fragment --><p>Handler for the result of Recognize option. It handles the value that user specified based on his initial choice (in case of the beginning of call the choice is <em>null</em>).</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> Task OnRecognizeCompleted(RecognizeOutcomeEvent recognizeOutcomeEvent)</div><div class="line">{</div><div class="line">    var callStateForClient = _callStateMap[recognizeOutcomeEvent.ConversationResult.Id];</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (callStateForClient.InitiallyChosenMenuOption)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> null:</div><div class="line">            ProcessMainMenuSelection(recognizeOutcomeEvent, callStateForClient);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> NewClient:</div><div class="line">            ProcessNewClientSelection(recognizeOutcomeEvent, callStateForClient);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> Support:</div><div class="line">            ProcessSupportSelection(recognizeOutcomeEvent, callStateForClient);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> Payments:</div><div class="line">            ProcessPaymentsSelection(recognizeOutcomeEvent, callStateForClient);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            SetupInitialMenu(recognizeOutcomeEvent.ResultingWorkflow);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> Task.FromResult(<span class="keyword">true</span>);</div><div class="line">}</div></div><!-- fragment --><p>Below are the methods for analyzing the choice the user has made. After choosing the option from initial menu the choice is saved in the state object. If the user chooses to contact the consultant we set up the recording of message for him.</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> <span class="keywordtype">void</span> ProcessMainMenuSelection(RecognizeOutcomeEvent outcome, CallState callStateForClient)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (outcome.RecognizeOutcome.Outcome != <a class="code" href="d9/dd2/namespace_microsoft_1_1_bot_1_1_builder_1_1_calling_1_1_object_model_1_1_misc.html#a37dcb2007b198097fc87a6eb50dd94ec">Outcome</a>.Success)</div><div class="line">    {</div><div class="line">        SetupInitialMenu(outcome.ResultingWorkflow);</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (outcome.RecognizeOutcome.ChoiceOutcome.ChoiceName)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> NewClient:</div><div class="line">            callStateForClient.InitiallyChosenMenuOption = NewClient;</div><div class="line">            outcome.ResultingWorkflow.Actions = <span class="keyword">new</span> List&lt;ActionBase&gt; { CreateNewClientMenu() };</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> Support:</div><div class="line">            callStateForClient.InitiallyChosenMenuOption = Support;</div><div class="line">            outcome.ResultingWorkflow.Actions = <span class="keyword">new</span> List&lt;ActionBase&gt; { CreateSupportMenu() };</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> Payments:</div><div class="line">            callStateForClient.InitiallyChosenMenuOption = Payments;</div><div class="line">            outcome.ResultingWorkflow.Actions = <span class="keyword">new</span> List&lt;ActionBase&gt; { CreatePaymentsMenu() };</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> MoreInfo:</div><div class="line">            callStateForClient.InitiallyChosenMenuOption = MoreInfo;</div><div class="line">            outcome.ResultingWorkflow.Actions = <span class="keyword">new</span> List&lt;ActionBase&gt; { GetPromptForText(IvrOptions.MoreInfoPrompt) };</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            SetupInitialMenu(outcome.ResultingWorkflow);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keywordtype">void</span> ProcessNewClientSelection(RecognizeOutcomeEvent outcome, CallState callStateForClient)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (outcome.RecognizeOutcome.Outcome != <a class="code" href="d9/dd2/namespace_microsoft_1_1_bot_1_1_builder_1_1_calling_1_1_object_model_1_1_misc.html#a37dcb2007b198097fc87a6eb50dd94ec">Outcome</a>.Success)</div><div class="line">    {</div><div class="line">        outcome.ResultingWorkflow.Actions = <span class="keyword">new</span> List&lt;ActionBase&gt; { CreateNewClientMenu() };</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (outcome.RecognizeOutcome.ChoiceOutcome.ChoiceName)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> NewClientOffer:</div><div class="line">            outcome.ResultingWorkflow.Actions = <span class="keyword">new</span> List&lt;ActionBase&gt;</div><div class="line">                {</div><div class="line">                    GetPromptForText(IvrOptions.Offer),</div><div class="line">                    CreateNewClientMenu()</div><div class="line">                };</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> NewClientOrder:</div><div class="line">            SetupRecording(outcome.ResultingWorkflow);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            callStateForClient.InitiallyChosenMenuOption = null;</div><div class="line">            SetupInitialMenu(outcome.ResultingWorkflow);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keywordtype">void</span> ProcessSupportSelection(RecognizeOutcomeEvent outcome, CallState callStateForClient)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (outcome.RecognizeOutcome.Outcome != <a class="code" href="d9/dd2/namespace_microsoft_1_1_bot_1_1_builder_1_1_calling_1_1_object_model_1_1_misc.html#a37dcb2007b198097fc87a6eb50dd94ec">Outcome</a>.Success)</div><div class="line">    {</div><div class="line">        outcome.ResultingWorkflow.Actions = <span class="keyword">new</span> List&lt;ActionBase&gt; { CreateSupportMenu() };</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (outcome.RecognizeOutcome.ChoiceOutcome.ChoiceName)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> SupportOutages:</div><div class="line">            outcome.ResultingWorkflow.Actions = <span class="keyword">new</span> List&lt;ActionBase&gt;</div><div class="line">                {</div><div class="line">                    GetPromptForText(IvrOptions.CurrentOutages),</div><div class="line">                    CreateSupportMenu()</div><div class="line">                };</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> SupportConsultant:</div><div class="line">            SetupRecording(outcome.ResultingWorkflow);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            callStateForClient.InitiallyChosenMenuOption = null;</div><div class="line">            SetupInitialMenu(outcome.ResultingWorkflow);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keywordtype">void</span> ProcessPaymentsSelection(RecognizeOutcomeEvent outcome, CallState callStateForClient)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (outcome.RecognizeOutcome.Outcome != <a class="code" href="d9/dd2/namespace_microsoft_1_1_bot_1_1_builder_1_1_calling_1_1_object_model_1_1_misc.html#a37dcb2007b198097fc87a6eb50dd94ec">Outcome</a>.Success)</div><div class="line">    {</div><div class="line">        outcome.ResultingWorkflow.Actions = <span class="keyword">new</span> List&lt;ActionBase&gt; { CreatePaymentsMenu() };</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (outcome.RecognizeOutcome.ChoiceOutcome.ChoiceName)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> PaymentDetails:</div><div class="line">            outcome.ResultingWorkflow.Actions = <span class="keyword">new</span> List&lt;ActionBase&gt;</div><div class="line">                {</div><div class="line">                    GetPromptForText(IvrOptions.PaymentDetailsMessage),</div><div class="line">                    CreatePaymentsMenu()</div><div class="line">                };</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> PaymentNotVisible:</div><div class="line">            SetupRecording(outcome.ResultingWorkflow);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            callStateForClient.InitiallyChosenMenuOption = null;</div><div class="line">            SetupInitialMenu(outcome.ResultingWorkflow);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>Once the recording is finished the call is hang up after playing simple thank you message. In the presented sample the actual recording is not used but this part can be easily changed.</p>
<p>The stream containing the recording is available as <em>recordOutcomeEvent.RecordedContent</em> if the recording was successful (check the <em>recordOutcomeEvent.RecordOutcome.Outcome</em> flag).</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> Task OnRecordCompleted(RecordOutcomeEvent recordOutcomeEvent)</div><div class="line">{</div><div class="line">    var <span class="keywordtype">id</span> = Guid.NewGuid().ToString();</div><div class="line"></div><div class="line">    recordOutcomeEvent.ResultingWorkflow.Actions = <span class="keyword">new</span> List&lt;ActionBase&gt;</div><div class="line">        {</div><div class="line">            GetPromptForText(IvrOptions.Ending),</div><div class="line">            <span class="keyword">new</span> Hangup { OperationId = <span class="keywordtype">id</span> }</div><div class="line">        };</div><div class="line">    recordOutcomeEvent.ResultingWorkflow.Links = null;</div><div class="line">    _callStateMap.Remove(recordOutcomeEvent.ConversationResult.Id);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> Task.FromResult(<span class="keyword">true</span>);</div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="ivrfinishingup"></a>
Finishing Up</h2>
<p>Compile the code, run it locally, and confirm no exceptions are being thrown.</p>
<p>Once you're sure the bot works locally, you are ready to deploy to <a class="el" href="dc/d75/namespace_microsoft_1_1_bot_1_1_builder_1_1_azure.html" title="Namespace for Azure extensions to the Microsoft Bot Builder SDK. ">Azure</a> using the same steps as in the tutorial <a href="http://docs.asp.net/en/latest/tutorials/publish-to-azure-webapp-using-vs.html">Publish to an Azure Web App using Visual Studio</a>. If you encounter the issues on service startup, setting the "Remove additional files at destination" option in publishing settings may help.</p>
<p>Add the bot to your contact list, and you're finished.</p>
<h2><a class="anchor" id="ivrtestingngrok"></a>
Testing with ngrok</h2>
<p>There are tools that can create a public URL to your local webserver on your machine, e.g. <a href="https://ngrok.com/">ngrok</a>.</p>
<p>We'll show how you can test your bot running locally over Skype.</p>
<p>You'll need to download ngrok and modify your bot's registration. First step is to start ngrok on your machine and map it to a local port (in our example we'll use port 12345):</p>
<div class="fragment"><div class="line">\&gt; ngrok http 12345</div></div><!-- fragment --><p>This will create a new tunnel from a public URL to localhost:12345 on your machine. After you start the command, you can see the status of the tunnel:</p>
<div class="fragment"><div class="line">ngrok by \@inconshreveable (Ctrl+C to quit)</div><div class="line"></div><div class="line">Tunnel <a class="code" href="dd/df7/namespace_microsoft_1_1_bot_1_1_builder_1_1_form_flow.html#ab2b85bccad5c568fc9db82cac5ab6354aec53a8c4f07baed5d8825072c89799be">Status</a> online  </div><div class="line">Update update available (version 2.0.24, Ctrl-U to update)  </div><div class="line">Version 2.0.19/2.0.25  </div><div class="line">Web Interface &lt;http:<span class="comment">//127.0.0.1:4040&gt;  </span></div><div class="line">Forwarding http:<span class="comment">//78191649.ngrok.io -&gt; localhost:12345  </span></div><div class="line">Forwarding https:<span class="comment">//78191649.ngrok.io -&gt; localhost:12345  </span></div><div class="line"></div><div class="line">Connections ttl opn rt1 rt5 p50 p90  </div><div class="line">            0 0 0.00 0.00 0.00 0.00</div></div><!-- fragment --><p>Notice the "Forwarding" lines, in this case you can see that ngrok created two endpoints for us <a href="http://78191649.ngrok.io">http://78191649.ngrok.io</a> and <a href="https://78191649.ngrok.io">https://78191649.ngrok.io</a> for http and https traffic.</p>
<p>The next step is to configure IIS Express to run our service on the port we specified (12345).</p>
<p>In Visual Studio please right click on the IvrSample project and choose Properties.</p>
<p>Set the port that will be used by IIS Express for local runs as shown below (creation of virtual directory may be required) and save the changes.</p>
<div class="image">
<img src="/en-us/images/ivr/image2.png" />
</div>
<p>Now we will need to configure IIS Express to serve requests coming from outside network. Please navigate to file IvrSample.vs\config\applicationhost.config inside the project. Locate the Ivr website inside &lt;sites&gt; section in the configuration file. It should contain lines:</p>
<div class="fragment"><div class="line">bindings&gt;</div><div class="line">   &lt;binding protocol=<span class="stringliteral">&quot;http&quot;</span> bindingInformation=<span class="stringliteral">&quot;*:12345:localhost&quot;</span> /&gt;</div><div class="line">/bindings&gt;</div></div><!-- fragment --><p>Please add second binding entry so the section looks like:</p>
<div class="fragment"><div class="line">bindings&gt;</div><div class="line">   &lt;binding protocol=<span class="stringliteral">&quot;http&quot;</span> bindingInformation=<span class="stringliteral">&quot;*:12345:localhost&quot;</span> /&gt;</div><div class="line">   &lt;binding protocol=<span class="stringliteral">&quot;http&quot;</span> bindingInformation=<span class="stringliteral">&quot;*:12345:*&quot;</span> /&gt;</div><div class="line">/bindings&gt;</div></div><!-- fragment --><p>Check if the IIS Express is running (if there is IIS Express icon in system tray). If yes, right click on the icon and choose Exit.</p>
<p>The next step is to configure your Bot in the portal to use ngrok endpoints.</p>
<p>Don't forget to append your route when updating the messaging URL, the new URL should look like this: <a href="https://78191649.ngrok.io/v1/call">https://78191649.ngrok.io/v1/call</a>.</p>
<p>Please also update the CallbackUrl setting in Web.config file (it should be <a href="https://78191649.ngrok.io/v1/callback">https://78191649.ngrok.io/v1/callback</a> in presented sample).</p>
<p>Now you can start your server locally and send messages to your bot over Skype, they will be sent by Bot Platform to <a href="https://78191649.ngrok.io/v1/">https://78191649.ngrok.io/v1/</a>call and ngrok will forward them to your machine. You just need to keep ngrok running.</p>
<p>You will see each request logged in the ngrok's tunnel status table:</p>
<div class="fragment"><div class="line">HTTP Requests</div><div class="line">-------------</div><div class="line">POST /api/calling/call                  200 OK</div></div><!-- fragment --><p>If you are done with testing, you can stop ngrok (Ctrl+C), your agent will stop working as there is nothing to forward the requests to your local server.</p>
<p>Note: Free version of ngrok will create a new unique URL for you every time you start it. That means you always need to go back and update the messaging URL for your bot. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<!-- id is needed for treeview function! -->
<div class="outline footer">
    <ul>
        <li><a href="//aka.ms/bf-contactus">Contact us</a></li>
        <li><a href="//aka.ms/bf-privacy">Privacy & cookies</a></li>
        <li><a href="//aka.ms/bf-terms">Terms of use</a></li>
        <li><a href="//aka.ms/bf-conduct">Code of conduct</a></li>
        <li>&copy; 2016 Microsoft</li>
    </ul>
</div>
<script src="//bot-framework.azureedge.net/libs/svgxuse.js"></script>
<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100954936); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100954936ns.gif" /></p></noscript>
</body>
</html>
