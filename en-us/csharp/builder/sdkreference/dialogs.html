<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Dialogs | Bot Builder SDK C# Reference Library | Bot Framework</title>
    <link href="tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="botframework.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="/css/documentation.css?1" />
    <script type="text/javascript" src="/css/documents.js"></script>
    <!-- START OF SmartSource Data Collector TAG v10.4.23 -->
    <!-- Copyright (c) 2016 Webtrends Inc.  All rights reserved. -->
    <script type="text/javascript" src="/js/webtrends.load.js"></script>
    <!--
      appInsights
    -->
    <script type="text/javascript">
    var appInsights=window.appInsights||function(config){
      function r(config){t[config]=function(){var i=arguments;t.queue.push(function(){t[config].apply(t,i)})}}var t={config:config},u=document,e=window,o="script",s=u.createElement(o),i,f;for(s.src=config.url||"//az416426.vo.msecnd.net/scripts/a/ai.0.js",u.getElementsByTagName(o)[0].parentNode.appendChild(s),t.cookie=u.cookie,t.queue=[],i=["Event","Exception","Metric","PageView","Trace"];i.length;)r("track"+i.pop());return r("setAuthenticatedUserContext"),r("clearAuthenticatedUserContext"),config.disableExceptionTracking||(i="onerror",r("_"+i),f=e[i],e[i]=function(config,r,u,e,o){var s=f&&f(config,r,u,e,o);return s!==!0&&t["_"+i](config,r,u,e,o),s}),t
      }({
          instrumentationKey:"ecf7f29d-de8c-4169-a492-bdce0a32c300"
      });
      window.appInsights=appInsights;
      appInsights.trackPageView();
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            var sidenav = $('#side-nav');
            sidenav.before('<div id="content-container" class="outline"></div>');
            var doccontent = $('#doc-content');
			var contentcontainer = $('#content-container');
            contentcontainer.append(sidenav);
            contentcontainer.append(doccontent);
            doccontent.prepend($('#referenceSearch'));
			var top = $('#top');
			top.before('<div class="fullWidth"></div>');
			var fullwidth = $('div.fullWidth');
			fullwidth.before('<div id="app-body"></div>');
			fullwidth.append(top);
			fullwidth.append(contentcontainer);
			fullwidth.append($('.footer'));
			var appbody = $('#app-body');
			appbody.append(fullwidth);
			var navtreecontents = $('#nav-tree-contents');
			navtreecontents.prepend('<ul><li><div class="label"><a href="/">&lt; Documentation Home</a></div></li></ul>');
			//sidenav.prepend('<div id="wrapper"><form id="docs-search-form" action="/en-us/search/"><input id="q" name="q" type="text" placeholder=""><input type="hidden" id="v" name="v" value="v3"><input type="hidden" id="mkt" name="mkt" value="en-us"><button id="bt_search" name="bt_search" class="icon-search" type="submit"></button></form></div>');
            //sidenav.prepend('<div id="wrapper"><form id="docs-search-form" action="/en-us/search/"><select id="lang-select" name="lang" ><option value="">All</option><option value="node">Node.js</option><option value="csharp">.NET</option></select><input id="q" name="q" type="text" placeholder=""><input type="hidden" id="v" name="v" value="v3"><input type="hidden" id="mkt" name="mkt" value="en-us"><button id="bt_search" name="bt_search" class="icon-search" type="submit"></button></form></div>');
            setProgrammingLanguage();
			$('#MSearchField').removeAttr('value').attr('placeholder', 'Search the Bot Builder SDK C# reference');
        });
    </script>
</head>
<body>
    <div id="referenceSearch"></div>
    <div id="top">
        <!-- do not remove this div, it is closed by doxygen! -->
        <div>
            <header>
                <div class="outline">
                    <div class="header">
                        <a class="logo" href="//www.microsoft.com">
                            <svg class="svgicon svgicon-microsoft-color-logo">
                                <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="/images/symbol-defs.svg#svgicon-microsoft-color-logo"></use>
                            </svg>
                        </a>
                        <div class="loading-animation"></div>
                        <span class="environment"></span>
                        <div>
                        </div>
                    </div>
                </div>
            </header>
            <div class="brand-primary">
                <div class="jumbo">
                    <div class="jumbo-header"><a href="https://www.botframework.com/">Bot Framework</a></div>
                    <ul class="header-nav">
                        <li><a href="https://dev.botframework.com/#/bots">My bots</a></li>
                        <li><a href="https://dev.botframework.com/#/bots/new">Register a bot</a></li>
                        <li class="active"><a href="/">Documentation</a></li>
                        <li><a href="https://bots.botframework.com/">Bot Directory</a></li>
                        <li><a href="https://blog.botframework.com/">Blog</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- end header part -->
</body>
</html><!-- Generated by Doxygen 1.8.11 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dialogs.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Dialogs </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="Overview"></a>
Overview</h1>
<p>Dialogs model a conversational process, where the exchange of messages between bot and user is the primary channel for interaction with the outside world. Each dialog is an abstraction that encapsulates its own state in a C# class that implements <a class="el" href="dd/d5e/interface_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_i_dialog.html" title="A IDialog&lt;T&gt; is a suspendable conversational process that produces a result of type T ...">IDialog</a>. Dialogs can be composed with other dialogs to maximize reuse, and a dialog context maintains a stack of dialogs active in the conversation. A conversation composed of dialogs is portable across machines to make it possible to scale a bot implementation. This conversation state (the stack of active dialogs and each dialog's state) is stored in the state service provided by the Bot <a class="el" href="dd/d13/namespace_microsoft_1_1_bot_1_1_builder_1_1_connector.html">Connector</a> service, making the bot implementation stateless between requests. (Much like a web application that does not store session state in the web server's memory.)</p>
<p>The best way to understand this is to work through some examples. The first example changes the code in the Bot Framework template to use dialogs from the Bot Builder. The second example, <a class="el" href="dialogs.html#echoBot">Echo Bot with State</a> builds on that to add some simple state. The final example <a class="el" href="dialogs.html#alarmBot">Alarm Bot</a> uses the <a href="http://luis.ai">LUIS</a> natural language framework and some of the built-in system prompts.</p>
<h1><a class="anchor" id="simpleEcho"></a>
Echo Bot</h1>
<p>This example starts with the bot you get by starting your bot the Bot Framework template which includes code to echo back what the user says. In order to change the echo example to use the Bot Builder, we first need to import the required namespace: </p><div class="fragment"><div class="line"><span class="keyword">using</span> <a class="code" href="d7/d4e/namespace_microsoft.html">Microsoft</a>.<a class="code" href="d5/d61/namespace_microsoft_1_1_bot.html">Bot</a>.<a class="code" href="d3/ddb/namespace_microsoft_1_1_bot_1_1_builder.html">Builder</a>.<a class="code" href="d1/d6a/namespace_microsoft_1_1_bot_1_1_builder_1_1_dialogs.html">Dialogs</a>;</div></div><!-- fragment --><p>Next we need to add a C# class to represent our conversation. You can do this by adding this class to your MessagesController.cs file:  <div class="fragment"><div class="line">    [Serializable]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class </span>EchoDialog : IDialog&lt;object&gt;</div><div class="line">    {</div><div class="line">        <span class="keyword">public</span> async Task <a class="code" href="d1/d6a/namespace_microsoft_1_1_bot_1_1_builder_1_1_dialogs.html#a1acd970046853677c3cec64c2a5160e3">StartAsync</a>(IDialogContext context)</div><div class="line">        {</div><div class="line">            context.Wait(MessageReceivedAsync);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">public</span> async Task MessageReceivedAsync(IDialogContext context, IAwaitable&lt;IMessageActivity&gt; argument)</div><div class="line">        {</div><div class="line">            var message = await argument;</div><div class="line">            await context.PostAsync(<span class="stringliteral">&quot;You said: &quot;</span> + message.Text);</div><div class="line">            context.Wait(MessageReceivedAsync);</div><div class="line">        }</div><div class="line">    }</div></div><!-- fragment --></p>
<p>Finally we need to wire the class into your Post method like this:  <div class="fragment"><div class="line">        <span class="keyword">public</span> <span class="keyword">virtual</span> async Task&lt;HttpResponseMessage&gt; Post([FromBody] Activity activity)</div><div class="line">        {</div><div class="line">            <span class="comment">// check if activity is of type message</span></div><div class="line">            <span class="keywordflow">if</span> (activity != null &amp;&amp; activity.GetActivityType() == ActivityTypes.Message)</div><div class="line">            {</div><div class="line">                await Conversation.SendAsync(activity, () =&gt; <span class="keyword">new</span> EchoDialog());</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                HandleSystemMessage(activity);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">return</span> <span class="keyword">new</span> HttpResponseMessage(<a class="code" href="d8/dd0/namespace_system.html">System</a>.Net.HttpStatusCode.Accepted);</div><div class="line">        }</div></div><!-- fragment --></p>
<p>The method is marked async because the Bot Builder makes use of the C# facilities for handling asynchronous communication. It returns a Task which is representing the task responsible for sending replies for the passed in Message. If there is an exception, the Task will contain the exception information. Within the Post method we call <a class="el" href="d9/de8/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_conversation.html#a00a038f65a58138efb9a500665d3bbeb" title="Process an incoming message within the conversation. ">Conversation.SendAsync</a> which is the root method for the Bot Builder SDK. It follows the dependency inversion principle (<a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle">https://en.wikipedia.org/wiki/Dependency_inversion_principle</a>) and does the following steps:</p><ul>
<li>Instantiate the required components.</li>
<li>Deserialize the dialog state (the dialog stack and each dialog's state) from IBotDataStore (the default implementation uses the Bot <a class="el" href="dd/d13/namespace_microsoft_1_1_bot_1_1_builder_1_1_connector.html">Connector</a> state API as backing IBotDataStore).</li>
<li>Resume the conversation processes where the Bot decided to suspend and wait for a message.</li>
<li>Send the replies.</li>
<li>Serialize the updated dialog state and persist it back to IBotDataStore.</li>
</ul>
<p>When your conversation first starts, there is no dialog state in the IBotDataStore so the delegate passed to <a class="el" href="d9/de8/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_conversation.html#a00a038f65a58138efb9a500665d3bbeb" title="Process an incoming message within the conversation. ">Conversation.SendAsync</a> will be used to construct an EchoDialog and it's StartAsync method will be called. In this case, StartAsync calls IDialogContext.Wait with the continuation delegate (our MessageReceivedAsync method) to call when there is a new message. In the initial case there is an immediate message available (the one that launched the dialog) and it is immediately passed To MessageReceivedAsync.</p>
<p>Within MessageReceivedAsync we wait for the message to come in and then post our response and wait for the next message. In this simple case the next message would again be processed by MessageReceivedAsync. Every time we call IDialogContext.Wait our bot is suspended and can be restarted on any machine that receives the message.</p>
<p>If you run and test this bot, it will behave exactly like the original one from the Bot Framework template. It is a little more complicated, but it allows you to compose together multiple dialogs into complex conversations without having to explicitly manage state.</p>
<h1><a class="anchor" id="echoBot"></a>
Echo Bot with State</h1>
<p>Now that we have an example of the Bot Builder framework we are going to build on it to add some dialog state and some commands to control that state. We are going to number the responses and allow the command "reset" to reset the count. All we need to do is to replace our EchoDialog with the one below.  <div class="fragment"><div class="line">    [Serializable]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class </span>EchoDialog : IDialog&lt;object&gt;</div><div class="line">    {</div><div class="line">        <span class="keyword">protected</span> <span class="keywordtype">int</span> count = 1;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> async Task <a class="code" href="d1/d6a/namespace_microsoft_1_1_bot_1_1_builder_1_1_dialogs.html#a1acd970046853677c3cec64c2a5160e3">StartAsync</a>(IDialogContext context)</div><div class="line">        {</div><div class="line">            context.Wait(MessageReceivedAsync);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">virtual</span> async Task MessageReceivedAsync(IDialogContext context, IAwaitable&lt;IMessageActivity&gt; argument)</div><div class="line">        {</div><div class="line">            var message = await argument;</div><div class="line">            <span class="keywordflow">if</span> (message.Text == <span class="stringliteral">&quot;reset&quot;</span>)</div><div class="line">            {</div><div class="line">                PromptDialog.Confirm(</div><div class="line">                    context,</div><div class="line">                    AfterResetAsync,</div><div class="line">                    <span class="stringliteral">&quot;Are you sure you want to reset the count?&quot;</span>,</div><div class="line">                    <span class="stringliteral">&quot;Didn&#39;t get that!&quot;</span>,</div><div class="line">                    promptStyle: <a class="code" href="d1/d6a/namespace_microsoft_1_1_bot_1_1_builder_1_1_dialogs.html#a8e0b95fd4acd5831ff99c381d8c65bea">PromptStyle</a>.None);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                await context.PostAsync($<span class="stringliteral">&quot;{this.count++}: You said {message.Text}&quot;</span>);</div><div class="line">                context.Wait(MessageReceivedAsync);</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">public</span> async Task AfterResetAsync(IDialogContext context, IAwaitable&lt;bool&gt; argument)</div><div class="line">        {</div><div class="line">            var confirm = await argument;</div><div class="line">            <span class="keywordflow">if</span> (confirm)</div><div class="line">            {</div><div class="line">                this.count = 1;</div><div class="line">                await context.PostAsync(<span class="stringliteral">&quot;Reset count.&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                await context.PostAsync(<span class="stringliteral">&quot;Did not reset count.&quot;</span>);</div><div class="line">            }</div><div class="line">            context.Wait(MessageReceivedAsync);</div><div class="line">        }</div><div class="line">    }</div></div><!-- fragment --></p>
<p>The first change you will notice is the addition of <code>private int count = 1;</code>. This is the state we are persisting with this dialog on each message.</p>
<p>In MessageReceivedAsync we have added check to see if the input was "reset" and if that is true we use the built-in Prompts.Confirm dialog to spawn a sub-dialog that asks the user if they are sure about resetting the count. The sub-dialog has its own private state and does not need to worry about interfering with the parent dialog. When the sub dialog is done, it's result is then passed onto the AfterResetAync method. In AfterResetAsync we check on the response and perform the action including sending a message back to the user. The final step is to do IDialogContext.Wait with a continuation back to MessageReceivedAsync on the next message.</p>
<h1><a class="anchor" id="alarmBot"></a>
Alarm Bot</h1>
<p>This example is more complex and shows how to integrate <a href="http://luis.ai">LUIS</a> together with <a class="el" href="d9/d03/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_prompt_dialog.html" title="Dialog factory for simple prompts. ">PromptDialog</a> to create an alarm system you can interact with through natural language. In order to create a dialog that uses <a href="http://luis.ai">LUIS</a> you need to create a class that derives from <a class="el" href="d8/df9/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_luis_dialog.html" title="A dialog specialized to handle intents and entities from LUIS. ">LuisDialog</a> like this:  <div class="fragment"><div class="line">    [LuisModel(<span class="stringliteral">&quot;c413b2ef-382c-45bd-8ff0-f76d60e2a821&quot;</span>, <span class="stringliteral">&quot;6d0966209c6e4f6b835ce34492f3e6d9&quot;</span>)]</div><div class="line">    [Serializable]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class </span>SimpleAlarmDialog : LuisDialog&lt;object&gt;</div><div class="line">    {</div></div><!-- fragment --></p>
<p>The parameters to the LuisModel attribute are the <a href="http://luis.ai">LUIS</a> REST endpoint and key. Here we have supplied some values that will work, but the endpoint may be throttled in which case you will need to setup your own endpoint as described in <a href="http://aka.ms/bf-node-nl">How to Setup LUIS</a>.</p>
<p>Within the SimpleAlarmDialog class any method with the name of the <a href="http://luis.ai">LUIS</a> intent or marked with the LuisIntent attribute is called when that intent is matched. For example here is the handler for turning off an alarm, i.e. the intent "builtin.intent.alarm.turn_off_alarm":  <div class="fragment"><div class="line">        [LuisIntent(<span class="stringliteral">&quot;builtin.intent.alarm.turn_off_alarm&quot;</span>)]</div><div class="line">        <span class="keyword">public</span> async Task TurnOffAlarm(IDialogContext context, LuisResult result)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (TryFindAlarm(result, out this.turnOff))</div><div class="line">            {</div><div class="line">                PromptDialog.Confirm(context, AfterConfirming_TurnOffAlarm, <span class="stringliteral">&quot;Are you sure?&quot;</span>, promptStyle: <a class="code" href="d1/d6a/namespace_microsoft_1_1_bot_1_1_builder_1_1_dialogs.html#a8e0b95fd4acd5831ff99c381d8c65bea">PromptStyle</a>.None);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                await context.PostAsync(<span class="stringliteral">&quot;did not find alarm&quot;</span>);</div><div class="line">                context.Wait(MessageReceived);</div><div class="line">            }</div><div class="line">        }</div></div><!-- fragment --> Within the handler you can see the confirmation done using the built-in Prompt.Confirm dialog. The confirm dialog will spawn a sub-dialog for verifying the alarm deletion. Here is the full example: </p><div class="fragment"><div class="line"><span class="keyword">using</span> <a class="code" href="d8/dd0/namespace_system.html">System</a>;</div><div class="line"><span class="keyword">using</span> <a class="code" href="d8/dd0/namespace_system.html">System</a>.Collections.Generic;</div><div class="line"><span class="keyword">using</span> <a class="code" href="d8/dd0/namespace_system.html">System</a>.Linq;</div><div class="line"><span class="keyword">using</span> <a class="code" href="d8/dd0/namespace_system.html">System</a>.Threading.Tasks;</div><div class="line"></div><div class="line"><span class="keyword">using</span> <a class="code" href="d7/d4e/namespace_microsoft.html">Microsoft</a>.<a class="code" href="d5/d61/namespace_microsoft_1_1_bot.html">Bot</a>.<a class="code" href="d3/ddb/namespace_microsoft_1_1_bot_1_1_builder.html">Builder</a>.<a class="code" href="d1/d6a/namespace_microsoft_1_1_bot_1_1_builder_1_1_dialogs.html">Dialogs</a>;</div><div class="line"><span class="keyword">using</span> <a class="code" href="d7/d4e/namespace_microsoft.html">Microsoft</a>.<a class="code" href="d5/d61/namespace_microsoft_1_1_bot.html">Bot</a>.<a class="code" href="d3/ddb/namespace_microsoft_1_1_bot_1_1_builder.html">Builder</a>.<a class="code" href="da/d62/namespace_microsoft_1_1_bot_1_1_builder_1_1_luis.html">Luis</a>;</div><div class="line"><span class="keyword">using</span> <a class="code" href="d7/d4e/namespace_microsoft.html">Microsoft</a>.<a class="code" href="d5/d61/namespace_microsoft_1_1_bot.html">Bot</a>.<a class="code" href="d3/ddb/namespace_microsoft_1_1_bot_1_1_builder.html">Builder</a>.<a class="code" href="da/d62/namespace_microsoft_1_1_bot_1_1_builder_1_1_luis.html">Luis</a>.<a class="code" href="dc/d5f/namespace_microsoft_1_1_bot_1_1_builder_1_1_luis_1_1_models.html">Models</a>;</div><div class="line"></div><div class="line"><span class="keyword">namespace </span><a class="code" href="d7/d4e/namespace_microsoft.html">Microsoft</a>.Bot.Sample.SimpleAlarmBot</div><div class="line">{</div><div class="line">    [LuisModel(<span class="stringliteral">&quot;c413b2ef-382c-45bd-8ff0-f76d60e2a821&quot;</span>, <span class="stringliteral">&quot;6d0966209c6e4f6b835ce34492f3e6d9&quot;</span>)]</div><div class="line">    [Serializable]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class </span>SimpleAlarmDialog : LuisDialog&lt;object&gt;</div><div class="line">    {</div><div class="line">        <span class="keyword">private</span> readonly Dictionary&lt;string, Alarm&gt; alarmByWhat = <span class="keyword">new</span> Dictionary&lt;string, Alarm&gt;();</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="keywordtype">string</span> DefaultAlarmWhat = <span class="stringliteral">&quot;default&quot;</span>;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keywordtype">bool</span> TryFindAlarm(LuisResult result, out Alarm alarm)</div><div class="line">        {</div><div class="line">            alarm = null;</div><div class="line"></div><div class="line">            <span class="keywordtype">string</span> what;</div><div class="line"></div><div class="line">            EntityRecommendation title;</div><div class="line">            <span class="keywordflow">if</span> (result.TryFindEntity(Entity_Alarm_Title, out title))</div><div class="line">            {</div><div class="line">                what = title.Entity;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                what = DefaultAlarmWhat;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">return</span> this.alarmByWhat.TryGetValue(what, out alarm);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="keywordtype">string</span> Entity_Alarm_Title = <span class="stringliteral">&quot;builtin.alarm.title&quot;</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="keywordtype">string</span> Entity_Alarm_Start_Time = <span class="stringliteral">&quot;builtin.alarm.start_time&quot;</span>;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="keywordtype">string</span> Entity_Alarm_Start_Date = <span class="stringliteral">&quot;builtin.alarm.start_date&quot;</span>;</div><div class="line"></div><div class="line">        [LuisIntent(<span class="stringliteral">&quot;&quot;</span>)]</div><div class="line">        <span class="keyword">public</span> async Task <a class="code" href="d1/d6a/namespace_microsoft_1_1_bot_1_1_builder_1_1_dialogs.html#a8e0b95fd4acd5831ff99c381d8c65beaa6adf97f83acf6453d4a6a4b1070f3754">None</a>(IDialogContext context, LuisResult result)</div><div class="line">        {</div><div class="line">            <span class="keywordtype">string</span> message = $<span class="stringliteral">&quot;Sorry I did not understand: &quot;</span> + <span class="keywordtype">string</span>.Join(<span class="stringliteral">&quot;, &quot;</span>, result.Intents.Select(i =&gt; i.Intent));</div><div class="line">            await context.PostAsync(message);</div><div class="line">            context.Wait(MessageReceived);</div><div class="line">        }</div><div class="line"></div><div class="line">        [LuisIntent(<span class="stringliteral">&quot;builtin.intent.alarm.delete_alarm&quot;</span>)]</div><div class="line">        <span class="keyword">public</span> async Task DeleteAlarm(IDialogContext context, LuisResult result)</div><div class="line">        {</div><div class="line">            Alarm alarm;</div><div class="line">            <span class="keywordflow">if</span> (TryFindAlarm(result, out alarm))</div><div class="line">            {</div><div class="line">                this.alarmByWhat.Remove(alarm.What);</div><div class="line">                await context.PostAsync($<span class="stringliteral">&quot;alarm {alarm} deleted&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                await context.PostAsync(<span class="stringliteral">&quot;did not find alarm&quot;</span>);</div><div class="line">            }</div><div class="line"></div><div class="line">            context.Wait(MessageReceived);</div><div class="line">        }</div><div class="line"></div><div class="line">        [LuisIntent(<span class="stringliteral">&quot;builtin.intent.alarm.find_alarm&quot;</span>)]</div><div class="line">        <span class="keyword">public</span> async Task FindAlarm(IDialogContext context, LuisResult result)</div><div class="line">        {</div><div class="line">            Alarm alarm;</div><div class="line">            <span class="keywordflow">if</span> (TryFindAlarm(result, out alarm))</div><div class="line">            {</div><div class="line">                await context.PostAsync($<span class="stringliteral">&quot;found alarm {alarm}&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                await context.PostAsync(<span class="stringliteral">&quot;did not find alarm&quot;</span>);</div><div class="line">            }</div><div class="line"></div><div class="line">            context.Wait(MessageReceived);</div><div class="line">        }</div><div class="line"></div><div class="line">        [LuisIntent(<span class="stringliteral">&quot;builtin.intent.alarm.set_alarm&quot;</span>)]</div><div class="line">        <span class="keyword">public</span> async Task SetAlarm(IDialogContext context, LuisResult result)</div><div class="line">        {</div><div class="line">            EntityRecommendation title;</div><div class="line">            <span class="keywordflow">if</span> (!result.TryFindEntity(Entity_Alarm_Title, out title))</div><div class="line">            {</div><div class="line">                title = <span class="keyword">new</span> EntityRecommendation(type: Entity_Alarm_Title) { Entity = DefaultAlarmWhat };</div><div class="line">            }</div><div class="line"></div><div class="line">            EntityRecommendation date;</div><div class="line">            <span class="keywordflow">if</span> (!result.TryFindEntity(Entity_Alarm_Start_Date, out date))</div><div class="line">            {</div><div class="line">                date = <span class="keyword">new</span> EntityRecommendation(type: Entity_Alarm_Start_Date) { Entity = <span class="keywordtype">string</span>.Empty };</div><div class="line">            }</div><div class="line"></div><div class="line">            EntityRecommendation time;</div><div class="line">            <span class="keywordflow">if</span> (!result.TryFindEntity(Entity_Alarm_Start_Time, out time))</div><div class="line">            {</div><div class="line">                time = <span class="keyword">new</span> EntityRecommendation(type: Entity_Alarm_Start_Time) { Entity = <span class="keywordtype">string</span>.Empty };</div><div class="line">            }</div><div class="line"></div><div class="line">            var parser = <span class="keyword">new</span> <a class="code" href="d9/d58/namespace_chronic.html">Chronic</a>.Parser();</div><div class="line">            var span = parser.Parse(date.Entity + <span class="stringliteral">&quot; &quot;</span> + time.Entity);</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (span != null)</div><div class="line">            {</div><div class="line">                var when = span.Start ?? span.End;</div><div class="line">                var alarm = <span class="keyword">new</span> Alarm() { What = title.Entity, When = when.Value };</div><div class="line">                this.alarmByWhat[alarm.What] = alarm;</div><div class="line"></div><div class="line">                <span class="keywordtype">string</span> reply = $<span class="stringliteral">&quot;alarm {alarm} created&quot;</span>;</div><div class="line">                await context.PostAsync(reply);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                await context.PostAsync(<span class="stringliteral">&quot;could not find time for alarm&quot;</span>);</div><div class="line">            }</div><div class="line"></div><div class="line">            context.Wait(MessageReceived);</div><div class="line">        }</div><div class="line"></div><div class="line">        [LuisIntent(<span class="stringliteral">&quot;builtin.intent.alarm.snooze&quot;</span>)]</div><div class="line">        <span class="keyword">public</span> async Task AlarmSnooze(IDialogContext context, LuisResult result)</div><div class="line">        {</div><div class="line">            Alarm alarm;</div><div class="line">            <span class="keywordflow">if</span> (TryFindAlarm(result, out alarm))</div><div class="line">            {</div><div class="line">                alarm.When = alarm.When.Add(TimeSpan.FromMinutes(7));</div><div class="line">                await context.PostAsync($<span class="stringliteral">&quot;alarm {alarm} snoozed!&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                await context.PostAsync(<span class="stringliteral">&quot;did not find alarm&quot;</span>);</div><div class="line">            }</div><div class="line"></div><div class="line">            context.Wait(MessageReceived);</div><div class="line">        }</div><div class="line"></div><div class="line">        [LuisIntent(<span class="stringliteral">&quot;builtin.intent.alarm.time_remaining&quot;</span>)]</div><div class="line">        <span class="keyword">public</span> async Task TimeRemaining(IDialogContext context, LuisResult result)</div><div class="line">        {</div><div class="line">            Alarm alarm;</div><div class="line">            <span class="keywordflow">if</span> (TryFindAlarm(result, out alarm))</div><div class="line">            {</div><div class="line">                var now = <a class="code" href="dd/df7/namespace_microsoft_1_1_bot_1_1_builder_1_1_form_flow.html#a28ef6a551a3611e4a6abe06659797313a8cf10d2341ed01492506085688270c1e">DateTime</a>.UtcNow;</div><div class="line">                <span class="keywordflow">if</span> (alarm.When &gt; now)</div><div class="line">                {</div><div class="line">                    var remaining = alarm.When.Subtract(<a class="code" href="dd/df7/namespace_microsoft_1_1_bot_1_1_builder_1_1_form_flow.html#a28ef6a551a3611e4a6abe06659797313a8cf10d2341ed01492506085688270c1e">DateTime</a>.UtcNow);</div><div class="line">                    await context.PostAsync($<span class="stringliteral">&quot;There is {remaining} remaining for alarm {alarm}.&quot;</span>);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                    await context.PostAsync($<span class="stringliteral">&quot;The alarm {alarm} expired already.&quot;</span>);</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                await context.PostAsync(<span class="stringliteral">&quot;did not find alarm&quot;</span>);</div><div class="line">            }</div><div class="line"></div><div class="line">            context.Wait(MessageReceived);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">private</span> Alarm turnOff;</div><div class="line"></div><div class="line">        [LuisIntent(<span class="stringliteral">&quot;builtin.intent.alarm.turn_off_alarm&quot;</span>)]</div><div class="line">        <span class="keyword">public</span> async Task TurnOffAlarm(IDialogContext context, LuisResult result)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (TryFindAlarm(result, out this.turnOff))</div><div class="line">            {</div><div class="line">                PromptDialog.Confirm(context, AfterConfirming_TurnOffAlarm, <span class="stringliteral">&quot;Are you sure?&quot;</span>, promptStyle: <a class="code" href="d1/d6a/namespace_microsoft_1_1_bot_1_1_builder_1_1_dialogs.html#a8e0b95fd4acd5831ff99c381d8c65bea">PromptStyle</a>.None);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                await context.PostAsync(<span class="stringliteral">&quot;did not find alarm&quot;</span>);</div><div class="line">                context.Wait(MessageReceived);</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">public</span> async Task AfterConfirming_TurnOffAlarm(IDialogContext context, IAwaitable&lt;bool&gt; confirmation)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (await confirmation)</div><div class="line">            {</div><div class="line">                this.alarmByWhat.Remove(this.turnOff.What);</div><div class="line">                await context.PostAsync($<span class="stringliteral">&quot;Ok, alarm {this.turnOff} disabled.&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                await context.PostAsync(<span class="stringliteral">&quot;Ok! We haven&#39;t modified your alarms!&quot;</span>);</div><div class="line">            }</div><div class="line"></div><div class="line">            context.Wait(MessageReceived);</div><div class="line">        }</div><div class="line"></div><div class="line">        [LuisIntent(<span class="stringliteral">&quot;builtin.intent.alarm.alarm_other&quot;</span>)]</div><div class="line">        <span class="keyword">public</span> async Task AlarmOther(IDialogContext context, LuisResult result)</div><div class="line">        {</div><div class="line">            await context.PostAsync(<span class="stringliteral">&quot;what ?&quot;</span>);</div><div class="line">            context.Wait(MessageReceived);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">public</span> SimpleAlarmDialog()</div><div class="line">        {</div><div class="line"></div><div class="line">        }</div><div class="line">        <span class="keyword">public</span> SimpleAlarmDialog(ILuisService service)</div><div class="line">            : base(service)</div><div class="line">        {</div><div class="line">        }</div><div class="line"></div><div class="line">        [Serializable]</div><div class="line">        <span class="keyword">public</span> sealed <span class="keyword">class </span>Alarm : IEquatable&lt;Alarm&gt;</div><div class="line">        {</div><div class="line">            <span class="keyword">public</span> <a class="code" href="dd/df7/namespace_microsoft_1_1_bot_1_1_builder_1_1_form_flow.html#a28ef6a551a3611e4a6abe06659797313a8cf10d2341ed01492506085688270c1e">DateTime</a> When { <span class="keyword">get</span>; <span class="keyword">set</span>; }</div><div class="line">            <span class="keyword">public</span> <span class="keywordtype">string</span> What { <span class="keyword">get</span>; <span class="keyword">set</span>; }</div><div class="line"></div><div class="line">            <span class="keyword">public</span> <span class="keyword">override</span> <span class="keywordtype">string</span> ToString()</div><div class="line">            {</div><div class="line">                <span class="keywordflow">return</span> $<span class="stringliteral">&quot;[{this.What} at {this.When}]&quot;</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keyword">public</span> <span class="keywordtype">bool</span> Equals(Alarm other)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">return</span> other != null</div><div class="line">                    &amp;&amp; this.When == other.When</div><div class="line">                    &amp;&amp; this.What == other.What;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keyword">public</span> <span class="keyword">override</span> <span class="keywordtype">bool</span> Equals(<span class="keywordtype">object</span> other)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">return</span> Equals(other as Alarm);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keyword">public</span> <span class="keyword">override</span> <span class="keywordtype">int</span> GetHashCode()</div><div class="line">            {</div><div class="line">                <span class="keywordflow">return</span> this.What.GetHashCode();</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="IDialogContext"></a>
IDialogContext</h1>
<p>All of the dialogs take in an <a class="el" href="d1/dc6/interface_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_i_dialog_context.html" title="The context for the execution of a dialog&#39;s conversational process. ">IDialogContext</a>, an interface that provides the services needed to save state and communicate. The interface is composed of three interfaces: <a class="el" href="db/d9b/interface_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_internals_1_1_i_bot_data.html" title="Private bot data. ">Internals.IBotData</a>, <a class="el" href="de/db4/interface_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_internals_1_1_i_dialog_stack.html" title="The stack of dialogs in the conversational process. ">Internals.IDialogStack</a>, and <a class="el" href="d9/d2c/interface_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_internals_1_1_i_bot_to_user.html" title="Methods to send a message from the bot to the user. ">Internals.IBotToUser</a>.</p>
<p><a class="el" href="db/d9b/interface_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_internals_1_1_i_bot_data.html" title="Private bot data. ">Internals.IBotData</a> represents access to the per user, conversation, and private conversation, aka user in conversation state, maintained by the Bot <a class="el" href="dd/d13/namespace_microsoft_1_1_bot_1_1_builder_1_1_connector.html">Connector</a>. The per user state is useful for storing things about the user that cross conversations&ndash;for example the last sandwich order so that you can use that as the default when ordering a sandwich. It is also possible to store such state in your own store and use the Message.From.Id as a key.</p>
<p><a class="el" href="d9/d2c/interface_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_internals_1_1_i_bot_to_user.html" title="Methods to send a message from the bot to the user. ">Internals.IBotToUser</a> provides methods to post messages to be sent to the user, according to some policy. Some of these messages may be sent inline with the response to the web api method call, and some of these messages may be sent directly using the Bot <a class="el" href="dd/d13/namespace_microsoft_1_1_bot_1_1_builder_1_1_connector.html">Connector</a> client. Sending and receiving messages through the dialog context ensures the <a class="el" href="db/d9b/interface_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_internals_1_1_i_bot_data.html" title="Private bot data. ">Internals.IBotData</a> state is passed through the Bot <a class="el" href="dd/d13/namespace_microsoft_1_1_bot_1_1_builder_1_1_connector.html">Connector</a>.</p>
<p><a class="el" href="de/db4/interface_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_internals_1_1_i_dialog_stack.html" title="The stack of dialogs in the conversational process. ">Internals.IDialogStack</a> provides methods to:</p><ul>
<li>Call children dialogs and push the new child on the dialog stack.</li>
<li>Mark the current dialog as done and return a result to the calling dialog and pop the current dialog from the dialog stack.</li>
<li>Wait for a message from the user and suspend the conversation until the message arrives. The stack is usually automatically managed for you.</li>
</ul>
<h1><a class="anchor" id="Serialization"></a>
Serialization</h1>
<p>The dialog stack and the state of all active dialog are serialized to the per-user, per-conversation <a class="el" href="d7/dea/interface_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_i_bot_data_bag.html" title="A property bag of bot data. ">IBotDataBag</a>. This serialized blob is persisted through the Messages sent to and received from the Bot <a class="el" href="dd/d13/namespace_microsoft_1_1_bot_1_1_builder_1_1_connector.html">Connector</a>. Dialog classes must be marked with the serializable attribute so that Dialog object instances can participate in the runtime serialization. For example, all of the <a class="el" href="dd/d5e/interface_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_i_dialog.html" title="A IDialog&lt;T&gt; is a suspendable conversational process that produces a result of type T ...">IDialog</a> implementations in the builder library are marked as serializable. When custom serialization was desired, there is an ISerialization implementation and serialization constructor as well.</p>
<p>The <a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html" title="A fluent, chainable interface for IDialogs. ">Chain</a> methods provide a fluent interface to dialogs that is usable in LINQ query syntax. The compiled form of LINQ query syntax often leverages anonymous methods. If these anonymous methods do not reference the environment of local variables, then these anonymous methods have no state and are trivially serializable. However, if the anonymous method captures any local variable in the environment, the resulting closure object (generated by the compiler) is not marked as serializable. The Bot Builder will detect this situation and throw a ClosureCaptureException to help diagnose the issue.</p>
<p>If you wish to try to leverage reflection to serialize classes that are not marked as serializable, the library has a reflection-based serialization surrogate that can be registered with Autofac as follows: </p><div class="fragment"><div class="line">var builder = <span class="keyword">new</span> ContainerBuilder();</div><div class="line">builder.RegisterModule(<span class="keyword">new</span> DialogModule());</div><div class="line">builder.RegisterModule(<span class="keyword">new</span> ReflectionSurrogateModule());</div></div><!-- fragment --><h1><a class="anchor" id="Fluent"></a>
Dialog Chains</h1>
<p>Explicit management of the stack of active dialogs is possible through IDialogStack.Call&lt;R&gt; and IDialogStack.Done&lt;R&gt;, explicitly composing dialogs into a larger conversation. It is also possible to implicitly manage the stack of active dialogs through the fluent <a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html" title="A fluent, chainable interface for IDialogs. ">Chain</a> methods.</p>
<p>Here is an overview of the chain methods, followed by some examples.</p>
<table class="doxtable">
<tr>
<th>Name </th><th>Type </th><th>Notes  </th></tr>
<tr>
<td><a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#ae020518e9f5e5e94f71db9f33a1f7ebb" title="When the antecedent IDialog&lt;T&gt; has completed, project the result into a new IDialog&lt;R&gt;. ">Chain.Select&lt;T, R&gt;</a> </td><td>LINQ </td><td>Supports "select" and "let" in LINQ query syntax. </td></tr>
<tr>
<td><a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#a16e083616c5e63f0ad458de058ab9cb2" title="When the antecedent IDialog&lt;T&gt; has completed, execute the next IDialog&lt;C&gt;, and use the projection to ...">Chain.SelectMany&lt;T, C, R&gt;</a> </td><td>LINQ </td><td>Supports successive "from" in LINQ query syntax. </td></tr>
<tr>
<td><a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#ac5dde1f48f907314b6f346e8786aced6" title="When the antecedent IDialog&lt;T&gt; has completed, evaluate the predicate and decide whether to continue...">Chain.Where&lt;T&gt;</a> </td><td>LINQ </td><td>Supports "where" in LINQ query syntax. </td></tr>
<tr>
<td><a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#a27ee84c4646d5b5dbb4497d6da1409ec" title="Construct a IDialog&lt;T&gt; that will make a new copy of another IDialog&lt;T&gt; when started. ">Chain.From&lt;T&gt;</a> </td><td>Chains </td><td>Instantiates a new instance of a dialog. </td></tr>
<tr>
<td><a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#a205595c904e993e23669256f755270c2" title="Creates a IDialog&lt;T&gt; that returns a value. ">Chain.Return&lt;T&gt;</a> </td><td>Chains </td><td>Return a constant value into the chain. </td></tr>
<tr>
<td><a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#a38785ee72a3958e9e3d7454f9140afb7" title="Execute a side-effect after a IDialog&lt;T&gt; completes. ">Chain.Do&lt;T&gt;</a> </td><td>Chains </td><td>Allow for side-effects within the chain. </td></tr>
<tr>
<td><a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#a053d45bc16699d2978cf577750d1db11" title="When the antecedent IDialog&lt;T&gt; has completed, execute the continuation to produce the next IDialog&lt;R&gt;...">Chain.ContinueWith&lt;T, R&gt;</a> </td><td>Chains </td><td>Simple chaining of dialogs. </td></tr>
<tr>
<td><a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#aaf8d9d3e7c407f91044625a3e4e6c9f5" title="When the antecedent IDialog&lt;T&gt; where T is IDialog&lt;T&gt; completes, unwrap the result into a new IDialog&lt;...">Chain.Unwrap&lt;T&gt;</a> </td><td>Chains </td><td>Unwrap a dialog nested in a dialog. </td></tr>
<tr>
<td><a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#ac5242e4a112e55a87c5a793cb238a6af" title="When the antecedent IDialog&lt;T&gt; has completed, stop the propagation of Exception. ">Chain.DefaultIfException&lt;T&gt;</a> </td><td>Chains </td><td>Swallow exception from previous result and return default(T). </td></tr>
<tr>
<td><a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#af1213116d6b46a88b675b691bb357d7a" title="Loop the IDialog&lt;T&gt; forever. ">Chain.Loop&lt;T&gt;</a> </td><td>Branch </td><td>Loop the entire chain of dialogs. </td></tr>
<tr>
<td><a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#ad3289008cbb89c69fc939bee2cfcdc62" title="Fold items from an enumeration of dialogs. ">Chain.Fold&lt;T&gt;</a> </td><td>Branch </td><td>Fold results from an enumeration of dialogs into a single result. </td></tr>
<tr>
<td><a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#a0bf3925e4c00fac9bf86b560584b4f24" title="When the antecedent IDialog&lt;T&gt; has completed, go through each ICase&lt;T, R&gt; and run the ContextualSelec...">Chain.Switch&lt;T, R&gt;</a> </td><td>Branch </td><td>Support branching into different dialog chains. </td></tr>
<tr>
<td><a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#ab91eacd6492a4cab99b1eb9822716f1a" title="Post to the user the result of a IDialog&lt;T&gt;. ">Chain.PostToUser&lt;T&gt;</a> </td><td>Message </td><td>Post a message to the user. </td></tr>
<tr>
<td><a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#aaf6629303333a5395337c7571a65f590" title="Post to the chain the message to the bot after the antecedent completes. ">Chain.WaitToBot&lt;T&gt;</a> </td><td>Message </td><td>Wait for a message to the bot. </td></tr>
<tr>
<td><a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#a57b2b7c266fa9e07f908619b4521e5dc" title="Post the message from the user to Chain. ">Chain.PostToChain&lt;T&gt;</a> </td><td>Message </td><td>Start a chain with a message from the user. </td></tr>
</table>
<p>These <a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html" title="A fluent, chainable interface for IDialogs. ">Chain</a> methods fall into a few buckets.</p>
<p>LINQ query syntax starts off with the basic <a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#ae020518e9f5e5e94f71db9f33a1f7ebb" title="When the antecedent IDialog&lt;T&gt; has completed, project the result into a new IDialog&lt;R&gt;. ">Chain.Select&lt;T, R&gt;</a>:</p>
 <div class="fragment"><div class="line">            var query = from x in <span class="keyword">new</span> PromptDialog.PromptString(Prompt, Prompt, attempts: 1)</div><div class="line">                        let w = <span class="keyword">new</span> string(x.Reverse().ToArray())</div><div class="line">                        select w;</div></div><!-- fragment --></p>
<p>and LINQ query syntax is enhanced with support for <a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#a16e083616c5e63f0ad458de058ab9cb2" title="When the antecedent IDialog&lt;T&gt; has completed, execute the next IDialog&lt;C&gt;, and use the projection to ...">Chain.SelectMany&lt;T, C, R&gt;</a>:</p>
 <div class="fragment"><div class="line">            var query = from x in <span class="keyword">new</span> PromptDialog.PromptString(<span class="stringliteral">&quot;p1&quot;</span>, <span class="stringliteral">&quot;p1&quot;</span>, 1)</div><div class="line">                        from y in <span class="keyword">new</span> PromptDialog.PromptString(<span class="stringliteral">&quot;p2&quot;</span>, <span class="stringliteral">&quot;p2&quot;</span>, 1)</div><div class="line">                        select <span class="keywordtype">string</span>.Join(<span class="stringliteral">&quot; &quot;</span>, x, y);</div></div><!-- fragment --></p>
<p>Posting messages from the bot to the user and vice versa are supported by a <a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#ab91eacd6492a4cab99b1eb9822716f1a" title="Post to the user the result of a IDialog&lt;T&gt;. ">Chain.PostToUser&lt;T&gt;</a> and <a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#aaf6629303333a5395337c7571a65f590" title="Post to the chain the message to the bot after the antecedent completes. ">Chain.WaitToBot&lt;T&gt;</a>:</p>
 <div class="fragment"><div class="line">            query = query.PostToUser();</div></div><!-- fragment --></p>
<p>Branching conversation dialog flow is supported by <a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#a0bf3925e4c00fac9bf86b560584b4f24" title="When the antecedent IDialog&lt;T&gt; has completed, go through each ICase&lt;T, R&gt; and run the ContextualSelec...">Chain.Switch&lt;T, R&gt;</a>:</p>
 <div class="fragment"><div class="line">            var logic =</div><div class="line">                toBot</div><div class="line">                .Switch</div><div class="line">                (</div><div class="line">                    <span class="keyword">new</span> RegexCase&lt;string&gt;(<span class="keyword">new</span> Regex(<span class="stringliteral">&quot;^hello&quot;</span>), (context, text) =&gt;</div><div class="line">                    {</div><div class="line">                        <span class="keywordflow">return</span> <span class="stringliteral">&quot;world!&quot;</span>;</div><div class="line">                    }),</div><div class="line">                    <span class="keyword">new</span> Case&lt;string, string&gt;((txt) =&gt; txt == <span class="stringliteral">&quot;world&quot;</span>, (context, text) =&gt;</div><div class="line">                    {</div><div class="line">                        <span class="keywordflow">return</span> <span class="stringliteral">&quot;!&quot;</span>;</div><div class="line">                    }),</div><div class="line">                    <span class="keyword">new</span> DefaultCase&lt;string, string&gt;((context, text) =&gt;</div><div class="line">                   {</div><div class="line">                       <span class="keywordflow">return</span> text;</div><div class="line">                   }</div><div class="line">                )</div><div class="line">            );</div></div><!-- fragment --></p>
<p>If <a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#a0bf3925e4c00fac9bf86b560584b4f24" title="When the antecedent IDialog&lt;T&gt; has completed, go through each ICase&lt;T, R&gt; and run the ContextualSelec...">Chain.Switch&lt;T, R&gt;</a> returns a nested <a class="el" href="dd/d5e/interface_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_i_dialog.html" title="A IDialog&lt;T&gt; is a suspendable conversational process that produces a result of type T ...">IDialog</a>&lt;<a class="el" href="dd/d5e/interface_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_i_dialog.html">IDialog&lt;T&gt;</a>&gt;, then the inner <a class="el" href="dd/d5e/interface_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_i_dialog.html">IDialog&lt;T&gt;</a> can be unwrapped with <a class="el" href="de/dab/class_microsoft_1_1_bot_1_1_builder_1_1_dialogs_1_1_chain.html#aaf8d9d3e7c407f91044625a3e4e6c9f5" title="When the antecedent IDialog&lt;T&gt; where T is IDialog&lt;T&gt; completes, unwrap the result into a new IDialog&lt;...">Chain.Unwrap&lt;T&gt;</a>. This allows for branching in conversations to different paths of chained dialogs, possibly of unequal length. Here is a more complete example of branching dialogs written in the fluent chain style with implicit stack management:</p>
 <div class="fragment"><div class="line">            var joke = Chain</div><div class="line">                .PostToChain()</div><div class="line">                .Select(m =&gt; m.Text)</div><div class="line">                .Switch</div><div class="line">                (</div><div class="line">                    Chain.Case</div><div class="line">                    (</div><div class="line">                        <span class="keyword">new</span> Regex(<span class="stringliteral">&quot;^chicken&quot;</span>),</div><div class="line">                        (context, text) =&gt;</div><div class="line">                            Chain</div><div class="line">                            .Return(<span class="stringliteral">&quot;why did the chicken cross the road?&quot;</span>)</div><div class="line">                            .PostToUser()</div><div class="line">                            .WaitToBot()</div><div class="line">                            .Select(ignoreUser =&gt; <span class="stringliteral">&quot;to get to the other side&quot;</span>)</div><div class="line">                    ),</div><div class="line">                    Chain.Default&lt;string, IDialog&lt;string&gt;&gt;(</div><div class="line">                        (context, text) =&gt;</div><div class="line">                            Chain</div><div class="line">                            .Return(<span class="stringliteral">&quot;why don&#39;t you like chicken jokes?&quot;</span>)</div><div class="line">                    )</div><div class="line">                )</div><div class="line">                .Unwrap()</div><div class="line">                .PostToUser().</div><div class="line">                Loop();</div></div><!-- fragment --></p>
<h1><a class="anchor" id="Conclusion"></a>
Conclusion</h1>
<p>Through this description we have seen how you can easily create stateless bots that can reuse dialog building blocks ranging from simple prompts to advanced natural language. As a next step, you should explore <a class="el" href="forms.html">FormFlow</a> which describes how the Bot Builder framework can automatically build dialogs from a C# class you want the user to fill in. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<!-- id is needed for treeview function! -->
<div class="outline footer">
    <ul>
        <li><a href="//aka.ms/bf-contactus">Contact us</a></li>
        <li><a href="//aka.ms/bf-privacy">Privacy & cookies</a></li>
        <li><a href="//aka.ms/bf-terms">Terms of use</a></li>
        <li><a href="//aka.ms/bf-conduct">Code of conduct</a></li>
        <li>&copy; 2016 Microsoft</li>
    </ul>
</div>
<script src="//bot-framework.azureedge.net/libs/svgxuse.js"></script>
<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100954936); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100954936ns.gif" /></p></noscript>
</body>
</html>
